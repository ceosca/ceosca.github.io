<!DOCTYPE html>
<html>
<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/3.0.0/shaka-player.compiled.js"></script>
</head>
<body>
    <div id="playerContainer"></div>
    <div id="controls">
        <select id="channelSelector" style="display:none;" onchange="changeChannelManually()">
        </select>
    </div>
    <script>
        var player = null;
        var channels = [];
        var currentChannelIndex = null;
        var channelNumberBuffer = "";
        var timeoutId = null;
        var downArrowTimer = null;
        var upArrowTimer = null;

        fetch('https://ceosca.github.io/canales.json')
            .then(response => response.json())
            .then(data => {
                channels = data;
                cargarOpciones();
                cargarStream();
            })
            .catch(error => console.error('Error al cargar el JSON:', error));

        function cargarOpciones() {
            var selectBox = document.getElementById("channelSelector");
            channels.forEach(function(channel, index) {
                var option = document.createElement("option");
                option.text = channel.nombre;
                option.value = index;
                selectBox.add(option);
            });
            selectBox.selectedIndex = 0;
        }

        function cargarStream() {
            var selectedChannel = channels[currentChannelIndex];
            var manifestUri = selectedChannel.url;

            var config = {
                drm: {
                    servers: { 'com.widevine.alpha': selectedChannel.urlDrm }
                }
            };

            player = new shaka.Player(document.getElementById('playerContainer'));
            player.load(manifestUri).then(function() {
                console.log('El vídeo ha sido cargado correctamente!');
            }).catch(onError);
        }

        function changeChannel(offset) {
            if (channelNumberBuffer !== "") {
                currentChannelIndex = parseInt(channelNumberBuffer);
                channelNumberBuffer = "";
                cargarStream();
            } else {
                currentChannelIndex = (currentChannelIndex + offset + channels.length) % channels.length;
                cargarStream();
            }
        }

        function changeChannelManually() {
            var selectBox = document.getElementById("channelSelector");
            currentChannelIndex = parseInt(selectBox.value);
            channelNumberBuffer = "";
            cargarStream();
            ocultarSelector(); 
        }

        function ocultarSelector() {
            document.getElementById("channelSelector").style.display = "none"; 
        }

        function handleDownArrow() {
            downArrowTimer = setTimeout(function() {
                // Implementa lógica para cambiar audio si es necesario
            }, 1000);
        }

        function handleUpArrow() {
            upArrowTimer = setTimeout(function() {
                // Implementa lógica para cambiar audio si es necesario
            }, 1000);
        }

        function cancelDownArrowTimer() {
            clearTimeout(downArrowTimer);
        }

        function cancelUpArrowTimer() {
            clearTimeout(upArrowTimer);
        }

        document.addEventListener("keydown", function(event) {
            var keyCode = event.keyCode;
            if (keyCode === 13) { 
                document.getElementById("channelSelector").style.display = "block"; 
                document.getElementById("channelSelector").focus(); 
            } else if (keyCode === 37) {
                changeChannel(-1);
            } else if (keyCode === 39) {
                changeChannel(1);
            } else if (keyCode === 40) {
                handleDownArrow();
            } else if (keyCode === 38) {
                handleUpArrow();
            } else {
                var pressedKey = parseInt(event.key);
                if (!isNaN(pressedKey) && pressedKey >= 0 && pressedKey <= 9) {
                    clearTimeout(timeoutId);
                    channelNumberBuffer += event.key;
                    timeoutId = setTimeout(function() {
                        if (channelNumberBuffer !== "") {
                            currentChannelIndex = parseInt(channelNumberBuffer);
                            channelNumberBuffer = "";
                            cargarStream();
                        }
                    }, 1000);
                }
            }
        });

        document.addEventListener("keyup", function(event) {
            var keyCode = event.keyCode;
            if (keyCode === 40) {
                cancelDownArrowTimer();
            } else if (keyCode === 38) {
                cancelUpArrowTimer();
            }
        });

        function onError(event) {
            console.error('Error al cargar el vídeo:', event);
        }
    </script>
</body>
</html>
