<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>El Señor de los Cielos</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.0/FileSaver.min.js"></script>
</head>
<body>
<div>
  <label for="serie-nombre">Nombre:</label>
  <input type="text" id="serie-nombre">

  <label for="serie-genero">Género:</label>
  <input type="text" id="serie-genero">

  <label for="serie-año">Año:</label>
  <input type="text" id="serie-año">

  <label for="serie-reparto">Reparto:</label>
  <input type="text" id="serie-reparto">

  <label for="serie-pais">País de origen:</label>
  <input type="text" id="serie-pais">

  <label for="serie-temporadas">Temporadas:</label>
  <input type="number" id="serie-temporadas" min="1" max="100">

  <label for="serie-episodios">Episodios por temporada:</label>
  <input type="number" id="serie-episodios" min="1">

  <label for="serie-sinopsis">Sinopsis:</label>
  <textarea id="serie-sinopsis" rows="4"></textarea>

  <label for="serie-link">Link de la serie:</label>
  <input type="text" id="serie-link">

  <button id="generar-html">Generar HTML</button>
</div>

<hr>

<h1 id="titulo-serie"></h1>
<div id="ficha-serie"></div>

<script>
  const temporadaList = document.getElementById("serie-temporadas");
  const episodiosList = document.getElementById("serie-episodios");
  const fichaSerie = document.getElementById("ficha-serie");
  const tituloSerie = document.getElementById("titulo-serie");

  const generarHTMLButton = document.getElementById("generar-html");
  generarHTMLButton.addEventListener("click", generarHTML);

  function generarHTML() {
    const nombre = document.getElementById("serie-nombre").value;
    const genero = document.getElementById("serie-genero").value;
    const año = document.getElementById("serie-año").value;
    const reparto = document.getElementById("serie-reparto").value;
    const pais = document.getElementById("serie-pais").value;
    const temporadas = parseInt(document.getElementById("serie-temporadas").value);
    const episodios = parseInt(document.getElementById("serie-episodios").value);
    const sinopsis = document.getElementById("serie-sinopsis").value;
    const linkSerie = document.getElementById("serie-link").value;

    tituloSerie.textContent = nombre;

    let html = `
    <h1>${nombre}</h1>
    <p>Género: ${genero}</p>
    <p>Año: ${año}</p>
    <p>Reparto: ${reparto}</p>
    <p>País de origen: ${pais}</p>
    <p>Temporadas: ${temporadas}</p>
    <p>Episodios por temporada: ${episodios}</p>
    <hr>
    <h2>Sinopsis</h2>
    <p>${sinopsis}</p>
    <hr>
    <div id="temporadas">
      <label for="season-list">Selecciona la temporada:</label>
      <select id="season-list"></select>
      <div id="episodios"></div>
    </div>
    <hr>
    <audio id="repro" src="" type="audio/mpeg"></audio>
    <script>
      const audio = document.getElementById("repro");
      const chapterList = document.getElementById("chapter-list");
      const seasonList = document.getElementById("season-list");
      const playPauseButton = document.getElementById("play-pause");
      const backwardButton = document.getElementById("backward");
      const forwardButton = document.getElementById("forward");
      const volumeUpButton = document.getElementById("volume-up");
      const volumeDownButton = document.getElementById("volume-down");
      const rootLink = "${linkSerie}";

      const seasons = [`;

    for (let i = 0; i < temporadas; i++) {
      html += `{ name: "Temporada ${i + 1}", chapters: ${episodios} }`;
      if (i < temporadas - 1) {
        html += ', ';
      }
    }

    html += `];

      function setChapter() {
        const currentChapter = chapterList.value;
        const currentSeasonIndex = seasonList.selectedIndex;
        const currentSeason = seasons[currentSeasonIndex].name;
        audio.src = \`\${rootLink}\${currentSeason.toLowerCase().replace(" ", "-")}/\${currentChapter}.m4a\`;
        audio.load();
        audio.play();
      }

      function updatePlayPauseButton(title, ariaLabel) {
        playPauseButton.setAttribute("title", \`\${title} (Alt+K)\`);
        playPauseButton.setAttribute("aria-label", ariaLabel);
        playPauseButton.textContent = title;
      }

      function playPause() {
        if (audio.paused) {
          audio.play();
          updatePlayPauseButton("Pausar", "Pausar");
        } else {
          audio.pause();
          updatePlayPauseButton("Reproducir", "Reproducir");
        }
      }

      function skip(direction) {
        audio.currentTime += (direction === "forward" ? 10 : -10);
        audio.currentTime = Math.min(Math.max(audio.currentTime, 0), audio.duration);
      }

      function handleMediaKeys(event) {
        const mediaKeysMap = {
          "MediaPlayPause": playPause,
          "MediaTrackPrevious": () => skip("backward"),
          "MediaTrackNext": () => skip("forward"),
          "VolumeUp": () => audio.volume += 0.1,
          "VolumeDown": () => audio.volume -= 0.1,
          "VolumeMute": () => audio.muted = !audio.muted
        };
        const mediaKeyFunction = mediaKeysMap[event.code];
        if (mediaKeyFunction) {
          event.preventDefault();
          mediaKeyFunction();
        }
      }

      function checkAutoplay() {
        if (autoplay.checked) {
          const currentChapter = parseInt(chapterList.value) + 1;
          const currentSeasonIndex = seasonList.selectedIndex;
          let currentSeason = seasons[currentSeasonIndex].name;
          if (currentChapter > seasons[currentSeasonIndex].chapters) {
            currentSeasonIndex++;
            currentSeason = seasons[currentSeasonIndex].name;
            chapterList.selectedIndex = 0;
          }
          seasonList.selectedIndex = currentSeasonIndex;
          chapterList.value = currentChapter;
          setChapter();
        }
      }

      function setSpeakText() {
        const speakText = document.getElementById("speak-text");
        const currentTime = formatTime(audio.currentTime);
        const duration = formatTime(audio.duration);
        speakText.textContent = \`\${currentTime} de \${duration}\`;
      }

      function formatTime(time) {
        const minutes = Math.floor(time / 60);
        const seconds = Math.floor(time % 60);
        return \`\${minutes}:\${seconds < 10 ? '0' : ''}\${seconds}\`;
      }

      for (let i = 0; i < temporadas; i++) {
        const option = document.createElement("option");
        option.text = \`Temporada \${i + 1}\`;
        seasonList.add(option);
        if (i === 0) {
          option.selected = true;
        }
      }

      const currentSeasonIndex = seasonList.selectedIndex;
      const currentSeasonChapters = seasons[currentSeasonIndex].chapters;
      for (let chapter = 1; chapter <= currentSeasonChapters; chapter++) {
        const option = document.createElement("option");
        option.text = \`Capítulo \${chapter}\`;
        option.value = chapter;
        chapterList.add(option);
        if (chapter === 1) {
          option.selected = true;
        }
      }

      seasonList.addEventListener("change", () => {
        chapterList.options.length = 0;
        const currentSeasonIndex = seasonList.selectedIndex;
        const currentSeasonChapters = seasons[currentSeasonIndex].chapters;
        for (let chapter = 1; chapter <= currentSeasonChapters; chapter++) {
          const option = document.createElement("option");
          option.text = \`Capítulo \${chapter}\`;
          option.value = chapter;
          chapterList.add(option);
          if (chapter === 1) {
            option.selected = true;
          }
        }
        setChapter();
      });

      chapterList.addEventListener("change", setChapter);
      playPauseButton.addEventListener("click", playPause);
      backwardButton.addEventListener("click", () => skip("backward"));
      forwardButton.addEventListener("click", () => skip("forward"));
      volumeUpButton.addEventListener("click", () => audio.volume += 0.1);
      volumeDownButton.addEventListener("click", () => audio.volume -= 0.1);
      audio.addEventListener("timeupdate", setSpeakText);
      audio.addEventListener("ended", checkAutoplay);
      document.addEventListener("keydown", handleMediaKeys);

      setChapter(); // reproducción automática del capítulo seleccionado
    </script>
    `;
    
    fichaSerie.innerHTML = html;
    
    const blob = new Blob([html], { type: "text/html;charset=utf-8" });
    saveAs(blob, `${nombre}.html`);
  }
</script>
</body>
</html>
