<!DOCTYPE html><html lang="es"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Series</title><style>html,body{margin:0;padding:0;box-sizing:border-box}:root{--primary-color:#4CAF50;--primary-color-dark:#3e8e41;--text-color:#333;--bg-color:#f4f4f4;--white:#fff;--shadow:0 0 5px rgba(0,0,0,.1);--focus-outline:3px solid #007bff;--focus-outline-offset:2px}body{font-family:Arial,sans-serif;background-color:var(--bg-color);font-size:1.2em;line-height:1.6;color:var(--text-color)}h2{font-size:1.8em;margin-bottom:.5em}.container{width:95%;margin:10px auto;background-color:var(--white);padding:15px;box-shadow:var(--shadow)}.button{padding:8px 12px;border:none;cursor:pointer;border-radius:5px;transition:background-color .2s ease,box-shadow .2s ease;font-size:.9em;background-color:var(--primary-color);color:var(--white)}.button:hover,.button:focus{box-shadow:var(--shadow);outline:none}.button-primary:hover,.button-primary:focus{background-color:var(--primary-color-dark)}.series-list{list-style-type:none;padding:0}.series-list li{margin-bottom:10px}.series-list button{width:100%;text-align:left;font-size:1.1em;display:block;padding:12px 15px}.modal{display:none;position:fixed;z-index:1;left:0;top:0;width:100%;height:100%;overflow:auto;background-color:rgba(0,0,0,.7)}.modal-content{background-color:var(--white);margin:15% auto;padding:20px;border:1px solid #888;width:90%;position:relative;border-radius:10px;padding-top:60px;padding-bottom:90px}.fixed-header{position:fixed;top:0;left:0;width:100%;background-color:var(--white);padding:10px 20px;z-index:2;box-shadow:0 2px 5px rgba(0,0,0,.2);display:flex;justify-content:flex-end}.fixed-player{position:fixed;bottom:0;left:0;width:100%;background-color:#f0f0f0;padding:10px;text-align:center;z-index:2;box-shadow:0 -2px 5px rgba(0,0,0,.2);display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:5px}.fixed-player .player-controls,.fixed-player .player-options{display:flex;align-items:center;gap:5px;flex-wrap:nowrap}.fixed-player button{background-color:#555;color:var(--white);transition:background-color .3s;white-space:nowrap}.fixed-player button:hover{background-color:#777}.fixed-player #time-info,.fixed-player #chapter-info{font-size:.8em;color:var(--text-color);margin:0 5px;white-space:nowrap}.episodes-section,.languages-section,.speed-section{position:relative}.episodes-container,.languages-container,.speed-container{display:none;position:absolute;bottom:calc(100% + 5px);right:0;background-color:var(--white);border:1px solid #ccc;padding:10px;z-index:10;box-shadow:var(--shadow);border-radius:5px;min-width:180px}.episodes-container label,.languages-container label,.speed-container label{display:block;margin-bottom:.5em;font-size:1em;color:var(--text-color)}.episodes-container select,.languages-container select,.speed-container select{width:100%;padding:8px;font-size:.9em;border:1px solid #ccc;border-radius:5px;margin-bottom:5px}.languages-container select{appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 10px top 50%;background-size:1.5em}.hidden{display:none!important}*:focus{outline:var(--focus-outline);outline-offset:var(--focus-outline-offset)}@media (max-width:850px){.fixed-player{justify-content:center}.fixed-player .player-controls,.fixed-player .player-options{flex-basis:100%;justify-content:center;margin-top:5px}.episodes-container,.languages-container,.speed-container{min-width:150px}}#continue-watching{margin-bottom:20px}#continue-watching h2{font-size:1.5em;margin-bottom:10px}#continue-watching ul{list-style:none;padding:0}#continue-watching li{margin-bottom:5px}#episodes-section,#languages-section{margin:0;padding:0;display:block;position:static}</style></head><body><div class="container" id="main-container"><header><h2>Series de TV</h2><button id="google-sign-in" class="button">Iniciar sesión con Google</button><button id="sign-out" class="button hidden">Cerrar sesión</button></header><main><div id="continue-watching"><h2>Continuar escuchando</h2><ul id="cw-list"></ul></div><div id="countries-container"></div></main></div><div id="serieModal" class="modal" aria-hidden="true"><div class="modal-content" tabindex="-1"><header class="fixed-header"><button class="close button button-primary" id="closeModal">Regresar a explorar</button></header><main><div id="serie-info"></div></main><audio id="audio-player" preload="metadata">Audio no soportado.</audio><h2>Reproductor</h2><footer class="fixed-player"><div class="player-controls"><button id="play-pause-button" class="button" aria-label="Reproducir">Reproducir</button><button id="backward-button" class="button" aria-label="Retroceder 15 segundos">Retroceder</button><button id="forward-button" class="button" aria-label="Avanzar 15 segundos">Avanzar</button><button id="decrease-volume-button" class="button" aria-label="Bajar volumen">Bajar volumen</button><button id="increase-volume-button" class="button" aria-label="Subir volumen">Subir volumen</button><div id="time-info" aria-live="off">--:-- / --:--</div><div id="chapter-info" aria-live="polite"></div></div><div class="player-options"><button id="previous-chapter-button" class="button" aria-label="Ir al episodio anterior">Episodio anterior</button><button id="next-chapter-button" class="button" aria-label="Ir al siguiente episodio">Siguiente episodio</button><section class="episodes-section"><button id="episodes-button" class="button" aria-label="Episodios">Episodios</button><div class="episodes-container" id="episodes-container"><label for="capitulo">Capítulo:</label><select id="capitulo" aria-label="Seleccionar capítulo"><option value="">Seleccionar</option></select></div></section><section class="languages-section hidden"><button id="languages-button" class="button" aria-label="Cambiar Pista de Audio">Cambiar Pista de Audio</button><div class="languages-container" id="languages-container"><label for="language">Idioma:</label><select id="language" aria-label="Seleccionar idioma"></select></div></section><section class="speed-section"><button id="speed-button" class="button" aria-label="Velocidad">Velocidad</button><div class="speed-container" id="speed-container"><label for="speed">Velocidad:</label><select id="speed" aria-label="Seleccionar velocidad de reproducción"><option value="0.5">0.5x</option><option value="0.75">0.75x</option><option value="1" selected>1x (Normal)</option><option value="1.25">1.25x</option><option value="1.5">1.5x</option></select></div></section></div></footer></div></div><script type="module">import {initializeApp} from "https://www.gstatic.com/firebasejs/11.5.0/firebase-app.js";import {getFirestore,collection,doc,setDoc,getDoc,query,where,getDocs,serverTimestamp} from "https://www.gstatic.com/firebasejs/11.5.0/firebase-firestore.js";import {getAuth,signInWithPopup,GoogleAuthProvider,signOut,onAuthStateChanged} from "https://www.gstatic.com/firebasejs/11.5.0/firebase-auth.js";const firebaseConfig={apiKey:"AIzaSyAGzPA5b5P1NofFZtbBvGpuYE3tVR-JaS0",authDomain:"pfdsuaaug.firebaseapp.com",projectId:"pfdsuaaug",storageBucket:"pfdsuaaug.firebasestorage.app",messagingSenderId:"701797222900",appId:"1:701797222900:web:01836d45db1b35be2bd1a1"};const app=initializeApp(firebaseConfig),db=getFirestore(app),auth=getAuth(app),googleProvider=new GoogleAuthProvider();const GSIB=document.getElementById('google-sign-in'),SOB=document.getElementById('sign-out');const SIWG=async()=>{try{await signInWithPopup(auth,googleProvider)}catch{}},SOG=async()=>{try{await signOut(auth)}catch{}};onAuthStateChanged(auth,u=>{GSIB.classList.toggle('hidden',!!u);SOB.classList.toggle('hidden',!u);UCW()});GSIB.addEventListener('click',SIWG);SOB.addEventListener('click',SOG);const SD='https://ceosca.github.io/series/series.json',A=document.getElementById('audio-player'),MC=document.getElementById('main-container'),M=document.getElementById("serieModal"),CBC=document.getElementById("closeModal"),PB=document.getElementById('play-pause-button'),CS=document.getElementById('capitulo'),EC=document.getElementById('episodes-container'),EB=document.getElementById('episodes-button'),LC=document.getElementById('languages-container'),LS=document.getElementById('language'),LB=document.getElementById('languages-button'),LSect=document.querySelector('.languages-section'),CI=document.getElementById('chapter-info'),TI=document.getElementById('time-info'),CWL=document.getElementById('cw-list'),SB=document.getElementById('speed-button'),SC=document.getElementById('speed-container'),SS=document.getElementById('speed');let TII,IP=!1,CSD=[],CLI=0,CCI=0,S;const LBL_EPISODES='Episodios',LBL_LANG='Cambiar Pista de Audio',LBL_SPEED='Velocidad';const ARIA_HIDE_EPISODES='Ocultar lista de episodios',ARIA_HIDE_LANG='Ocultar Pistas de Audio',ARIA_HIDE_SPEED='Ocultar cambio de velocidad';const V=(el,btn,s,h,ariaS,ariaH)=>{const iH=el.style.display==='none'||el.classList.contains('hidden');el.style.display=iH?'block':'none';el.classList.toggle('hidden',!iH);if(btn){btn.textContent=iH?h:s;btn.setAttribute('aria-label',iH?ariaH:ariaS)}};const FT=t=>{t=Math.max(0,t);const m=Math.floor(t/60),s=Math.floor(t%60);return`${PZ(m)}:${PZ(s)}`},PZ=n=>(n<10?'0':'')+n;const GP=async()=>{if(!S?.nombre)return;const t=A.currentTime;if(isNaN(t))return;try{const u=auth.currentUser;if(!u)return;const p={sN:S.nombre,cI:CCI,t:t,lI:CLI,sp:A.playbackRate,uId:u.uid,lU:serverTimestamp()};await setDoc(doc(db,"progresoSeries",`${u.uid}_${S.nombre}`),p,{merge:!0});u&&UCW()}catch{}};const RP=async n=>{try{const u=auth.currentUser;if(!u)return!1;const dS=await getDoc(doc(db,"progresoSeries",`${u.uid}_${n}`));if(!dS.exists())return!1;const d=dS.data();let r=!1;d.cI!=null&&(CCI=d.cI);if(d.lI!=null&&d.lI!==CLI)CLI=d.lI,LS.value=CLI,r=!0;if(d.sp!=null)SS.value=d.sp,A.playbackRate=d.sp;else A.playbackRate=1,SS.value=1;const sT=d.t||0;CS.value=CCI;if(r){await LCF(S);A.addEventListener('canplay',()=>{A.currentTime=sT/* RP doesn't handle play intent directly */},{once:!0})}else{A.currentTime=sT}UC();return!0}catch{return!1}};const C=()=>{S&&GP();M.style.display="none";A.pause();A.src='';MC.classList.remove('hidden');clearInterval(TII);IP=!1;PB.textContent='Reproducir';PB.setAttribute('aria-label','Reproducir');TI.textContent='--:-- / --:--';CI.textContent='';[EC,LC,SC].forEach(e=>{e.style.display='none';e.classList.add('hidden')});EB.textContent=LBL_EPISODES;EB.setAttribute('aria-label',LBL_EPISODES);LB.textContent=LBL_LANG;LB.setAttribute('aria-label',LBL_LANG);SB.textContent=LBL_SPEED;SB.setAttribute('aria-label',LBL_SPEED)};const O=async s=>{S=s;IP=!1; /* Reset play state initially */ CLI=0;CCI=0;CSD=[];LI(s);LL(s);LSect.classList.toggle('hidden',!(S.enlaces?.length>1));await LCF(S); /* Load chapters, set initial audio src */ await RP(s.nombre); /* Restore progress, potentially change CLI and seek */ MC.classList.add('hidden');M.style.display="block";document.querySelector('#serieModal .modal-content')?.focus();[EC,LC,SC].forEach(e=>{e.style.display='none';e.classList.add('hidden')});EB.textContent=LBL_EPISODES;EB.setAttribute('aria-label',LBL_EPISODES);LB.textContent=LBL_LANG;LB.setAttribute('aria-label',LBL_LANG);SB.textContent=LBL_SPEED;SB.setAttribute('aria-label',LBL_SPEED);A.playbackRate=parseFloat(SS.value)||1;/* --- Explicit Autoplay Attempt --- */ try{await A.play();IP=!0;PB.textContent='Pausar';PB.setAttribute('aria-label','Pausar')}catch(err){IP=!1;PB.textContent='Reproducir';PB.setAttribute('aria-label','Reproducir')}};const FD=async()=>{try{const r=await fetch(SD);return r.ok?(await r.json()).series:[]}catch{return[]}};const RCAS=s=>{const t=document.getElementById('countries-container');t.innerHTML="";const p=[...new Set(s.map(s=>s.pais_origen))].sort();p.forEach(p=>{const h=document.createElement('h2');h.textContent=p;t.appendChild(h);const u=document.createElement('ul');u.className='series-list';s.filter(i=>i.pais_origen===p).sort((a,b)=>a.nombre.localeCompare(b.nombre)).forEach(i=>{const l=document.createElement('li'),b=document.createElement('button');b.textContent=i.nombre;b.onclick=()=>O(i);b.tabIndex=0;b.className='button';l.appendChild(b);u.appendChild(l)});t.appendChild(u)});UCW()};const LI=s=>{document.getElementById('serie-info').innerHTML=`<h2>${s.nombre}</h2><div><strong>Género:</strong> ${s.genero}</div><div><strong>Año:</strong> ${s.anio}</div><div><strong>Reparto:</strong> ${s.reparto.join(", ")}</div><div><strong>País:</strong> ${s.pais_origen}</div><div><strong>Episodios:</strong> ${s.cantidad_episodios}</div>${s.sinopsis?`<div><strong>Sinopsis:</strong> ${s.sinopsis}</div>`:''}`};const LL=s=>{LS.innerHTML='';s.enlaces?.forEach((l,i)=>{const o=document.createElement('option');o.value=i;o.textContent=l.idioma;LS.appendChild(o)});LSect.classList.toggle('hidden',!(s.enlaces?.length>1))};const LCF=async s=>{CLI=parseInt(LS.value)||0;CSD=s.capitulos||[];/* --- Populate Chapter Dropdown ONLY if empty --- */ if(CS.options.length<=1){CS.innerHTML='<option value="">Seleccionar</option>'; /* Keep default */ CSD.forEach((c,i)=>{const o=document.createElement('option');o.value=i;o.textContent=c.titulo;CS.appendChild(o)})}CS.value=CCI;UC();const url=s.enlaces?.[CLI]?.enlace;if(url){if(A.currentSrc!==url)A.src=url,A.load()}else A.src='';clearInterval(TII);UT();TII=setInterval(UT,1000)};const UC=()=>{CI.textContent=CSD?.[CCI]?`Ep: ${CSD[CCI].titulo}`:''};const GCI=t=>{let e=CCI;if(!CSD?.length)return e;const tS=t;for(let i=0;i<CSD.length;i++){const c=CSD[i];if(c?.inicio!=null&&c?.fin!=null){const iS=c.inicio/1000,fS=c.fin/1000;if(tS>=iS&&tS<fS){e=i;break}}}return e};const UT=()=>{if(!A||!CSD?.length){TI.textContent='--:-- / --:--';return}const t=A.currentTime;const cIdx=GCI(t);if(cIdx!==CCI&&IP){CCI=cIdx;CS.value=CCI;UC();GP()}const n=CSD[CCI];let dTS="--:--",dDS="--:--";if(n?.inicio!=null&&n?.fin!=null){const iS=n.inicio/1000,fS=n.fin/1000;if(t>=iS&&t<=fS){dTS=FT(t-iS);dDS=FT(fS-iS)}else if(t<iS){dTS=FT(0);dDS=FT(fS-iS)}}TI.textContent=`${dTS} / ${dDS}`};const TP=()=>{if(IP){A.pause();IP=!1;PB.textContent='Reproducir';PB.setAttribute('aria-label','Reproducir');GP()}else{if(!A.src||A.src===window.location.href){S&&CSD.length>0&&PC();return}A.play().then(()=>{IP=!0;PB.textContent='Pausar';PB.setAttribute('aria-label','Pausar')}).catch(()=>{IP=!1;PB.textContent='Reproducir';PB.setAttribute('aria-label','Reproducir')})}};const F=()=>{A.currentTime+=15},B=()=>{A.currentTime-=15};const TE=()=>{V(EC,EB,LBL_EPISODES,'Ocultar Epis.',LBL_EPISODES,ARIA_HIDE_EPISODES)},TL=()=>{V(LC,LB,LBL_LANG,'Ocultar Pistas',LBL_LANG,ARIA_HIDE_LANG)},TSp=()=>{V(SC,SB,LBL_SPEED,'Ocultar Vel.',LBL_SPEED,ARIA_HIDE_SPEED)};const PC=()=>{let sI=parseInt(CS.value);if(isNaN(sI)||!CSD?.[sI])return;CCI=sI;const chap=CSD[CCI];if(chap?.inicio!=null){A.currentTime=chap.inicio/1000;if(!IP)IP=!0; /* Assume intent to play */ A.play().then(()=>{PB.textContent='Pausar';PB.setAttribute('aria-label','Pausar');UC()}).catch(()=>{IP=!1;PB.textContent='Reproducir';PB.setAttribute('aria-label','Reproducir')});UC();GP()}else UC()};const PP=()=>{if(CCI>0)CS.value=--CCI,PC()},NP=()=>{if(CSD&&CCI<CSD.length-1)CS.value=++CCI,PC()};const CL=async()=>{const prevT=A.currentTime,prevCCI=CCI;CLI=parseInt(LS.value);if(isNaN(CLI))return;await LCF(S); /* LCF only loads src now */ A.addEventListener('canplay',()=>{const chap=CSD[prevCCI];let seekTime=prevT;if(chap?.inicio!=null){seekTime=chap.inicio/1000+Math.max(0,prevT-(chap.inicio/1000))}A.currentTime=seekTime;IP&&A.play()},{once:!0})};const ChSp=()=>{const r=parseFloat(SS.value);if(!isNaN(r))A.playbackRate=r;GP()};const IV=()=>{A.volume=Math.min(1,A.volume+.1)},DV=()=>{A.volume=Math.max(0,A.volume-.1)};const UCW=async()=>{CWL.innerHTML='';try{const u=auth.currentUser;if(!u)return;const q=query(collection(db,"progresoSeries"),where("uId","==",u.uid),where("t",">",10));const qS=await getDocs(q),c=[];qS.forEach(d=>c.push(d.data()));const s=await FD();for(const t of c){const sr=s.find(e=>e.nombre===t.sN);if(sr?.capitulos?.[t.cI]){const cap=sr.capitulos[t.cI];let remT="??:??";if(cap.fin!=null){const finS=cap.fin/1000;if(t.t<finS)remT=FT(finS-t.t)}if(remT!=="00:00"&&remT!=="??:??"){const li=document.createElement('li'),b=document.createElement('button');b.textContent=`Continuar ${sr.nombre}, ${cap.titulo} (Restante ${remT})`;b.onclick=()=>O(sr);b.className='button';li.appendChild(b);CWL.appendChild(li)}}}}catch{}};CBC.addEventListener('click',C);window.addEventListener('click',t=>{const tgt=t.target;tgt===M&&C();const cP=(el,btn,txt,ariaTxt)=>{if(!el.contains(tgt)&&!btn.contains(tgt)&&!el.classList.contains('hidden')){el.style.display='none';el.classList.add('hidden');btn.textContent=txt;btn.setAttribute('aria-label',ariaTxt)}};cP(EC,EB,LBL_EPISODES,LBL_EPISODES);cP(LC,LB,LBL_LANG,LBL_LANG);cP(SC,SB,LBL_SPEED,LBL_SPEED);});CS.addEventListener('change',PC);A.addEventListener('pause',()=>{IP=!1;PB.textContent='Reproducir';PB.setAttribute('aria-label','Reproducir');GP()});A.addEventListener('play',()=>{IP=!0;PB.textContent='Pausar';PB.setAttribute('aria-label','Pausar')});A.addEventListener('ended',()=>{IP=!1;PB.textContent='Reproducir';PB.setAttribute('aria-label','Reproducir');GP()});EB.addEventListener('click',TE);LB.addEventListener('click',TL);SB.addEventListener('click',TSp);LS.addEventListener('change',CL);SS.addEventListener('change',ChSp);PB.addEventListener('click',TP);document.getElementById('forward-button').addEventListener('click',F);document.getElementById('backward-button').addEventListener('click',B);document.getElementById('previous-chapter-button').addEventListener('click',PP);document.getElementById('next-chapter-button').addEventListener('click',NP);document.getElementById('increase-volume-button').addEventListener('click',IV);document.getElementById('decrease-volume-button').addEventListener('click',DV);window.onload=async()=>{RCAS(await FD())};setInterval(()=>{M.style.display==="block"&&S&&IP&&GP()},15000);</script></body></html>