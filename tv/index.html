<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Player TV</title>
    <script src="https://cdn.jsdelivr.net/npm/shaka-player@4.7.12/dist/shaka-player.ui.js"></script>
    <style>
        body {
            background-color: #000;
            color: #fff;
            font-family: sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
            cursor: none; /* Ocultar cursor */
        }
        
        /* Contenedor de información que aparece y desaparece */
        #infoContainer {
            text-align: center;
            opacity: 0; 
            transition: opacity 0.5s;
            pointer-events: none;
            z-index: 10;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
        }
        
        h1 { margin: 0; font-size: 3rem; text-shadow: 2px 2px 4px #000; font-weight: bold; }
        h2 { margin: 15px 0 0 0; color: #f1c40f; font-size: 2rem; text-shadow: 1px 1px 2px #000; font-weight: normal; }

        /* Número de canal grande */
        #channelNum { 
            font-size: 8rem; 
            font-weight: bold; 
            color: #fff; 
            text-shadow: 2px 2px 5px #000;
            position: absolute; 
            top: 20px; 
            right: 40px; 
            display: none; 
            z-index: 20;
        }

        /* Selector nativo (oculto) */
        #channelSelector {
            display: none;
            font-size: 1.5rem;
            padding: 10px;
            background: #222;
            color: white;
            border: 2px solid #555;
            position: absolute;
            bottom: 20px;
            z-index: 100;
        }
    </style>
</head>
<body>

    <!-- Feedback visual -->
    <div id="infoContainer">
        <h1 id="channelName"></h1>
        <h2 id="audioInfo"></h2>
    </div>
    
    <!-- Buffer numérico -->
    <div id="channelNum"></div>

    <!-- Elementos ocultos -->
    <audio id="audioPlayer" autoplay style="display:none;"></audio>
    <select id="channelSelector" onchange="changeChannelManually()"></select>

    <script type='text/javascript'>
        // CONFIGURACIÓN
        const K = [
            {n:"Base TV", u:"/tv/db.json"} 
        ];

        // VARIABLES
        var player = null;
        var canales = [];
        var currentChannelIndex = 0;
        var previousChannelIndex = -1; // Para Recall
        var channelNumberBuffer = "";
        var timeoutId = null;
        var infoTimer = null;

        // INICIO
        function initApp() {
            shaka.polyfill.installAll();
            if (shaka.Player.isBrowserSupported()) {
                var audioElement = document.getElementById('audioPlayer');
                player = new shaka.Player(audioElement);
                
                player.addEventListener('error', (e) => console.error('Error Shaka:', e));

                // Filtros de red (Limpieza de pipes |)
                player.getNetworkingEngine().registerRequestFilter((type, request) => {
                    if (type == shaka.net.NetworkingEngine.RequestType.MANIFEST || 
                        type == shaka.net.NetworkingEngine.RequestType.SEGMENT) {
                        let parts = request.uris[0].split("|");
                        request.uris[0] = parts[0];
                        if (parts.length > 1) {
                            for (let i = 1; i < parts.length; i++) {
                                let header = parts[i].split("=");
                                if (header.length === 2) request.headers[header[0]] = header[1];
                            }
                        }
                    }
                });

                cargarBaseDatos(K[0].u); 
            }
        }

        function cargarBaseDatos(url) {
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    canales = data;
                    cargarOpciones(); // Llena el select oculto
                    if(canales.length > 0) {
                        currentChannelIndex = 0;
                        cargarStream(false); // Carga inicial silenciosa (sin UI)
                    }
                })
                .catch(err => console.error('Error DB:', err));
        }

        function cargarOpciones() {
            var selectBox = document.getElementById("channelSelector");
            selectBox.innerHTML = "";
            canales.forEach(function(canal, index) {
                var option = document.createElement("option");
                option.text = (index + 1) + ". " + canal.nombre;
                option.value = index + 1;
                selectBox.add(option);
            });
            selectBox.selectedIndex = currentChannelIndex;
        }

        async function cargarStream(showInfo = true) {
            if (!canales[currentChannelIndex]) return;
            var selectedValue = canales[currentChannelIndex];
            
            // UI
            if(showInfo) showFeedback((currentChannelIndex + 1) + ". " + selectedValue.nombre, "");
            document.getElementById("channelSelector").selectedIndex = currentChannelIndex;

            // Lógica de Llaves (DRM)
            let drmConfig = {};
            if (selectedValue.clearkeys) {
                drmConfig = { clearKeys: selectedValue.clearkeys };
            } else if (selectedValue.keyId && selectedValue.key) {
                let keyIdLimpio = selectedValue.keyId.replace(/-/g, "");
                let keyLimpio = selectedValue.key.replace(/-/g, "");
                drmConfig = { clearKeys: { [keyIdLimpio]: keyLimpio } };
            }

            player.configure({
                drm: drmConfig,
                streaming: {
                    followRedirects: true,
                    // Forzar solo audio ahorra datos y evita decodificar video negro
                    restrictions: { maxHeight: 0 } 
                }
            });

            try {
                await player.load(selectedValue.url);
                var audioNode = document.getElementById('audioPlayer');
                audioNode.play().catch(()=>{});
            } catch (e) {
                console.error("Error carga:", e);
                if(showInfo) showFeedback("Error", "No se pudo cargar");
            }
        }

        // --- LÓGICA DE AUDIO (Basada en referencia HTML 2) ---
        function changeAudioTrack(offset) {
            // 1. Obtener lista completa de variantes de audio
            var tracks = player.getAudioLanguagesAndRoles(); // Devuelve [{language: 'es', role: 'main'}, ...]
            
            // 2. Extraer idiomas ÚNICOS (Mismo comportamiento que el combobox del html de referencia)
            var uniqueLangs = [];
            var seen = new Set();
            
            tracks.forEach(t => {
                if (!seen.has(t.language)) {
                    seen.add(t.language);
                    uniqueLangs.push(t.language);
                }
            });

            if (uniqueLangs.length <= 1) {
                showFeedback(null, "Audio Único");
                return;
            }

            // 3. Buscar el idioma actual ACTIVO
            // Buscamos en las pistas variantes cuál está activa y cuál es su idioma
            var currentVariant = player.getVariantTracks().find(t => t.active);
            var currentLang = currentVariant ? currentVariant.language : uniqueLangs[0];

            // 4. Calcular índice y nuevo idioma
            var currentIndex = uniqueLangs.indexOf(currentLang);
            if(currentIndex === -1) currentIndex = 0;

            var newIndex = (currentIndex + offset + uniqueLangs.length) % uniqueLangs.length;
            var newLang = uniqueLangs[newIndex];

            // 5. Aplicar cambio
            player.selectAudioLanguage(newLang);
            
            // 6. Feedback en pantalla (Convertir 'es' a 'ES', etc.)
            var label = newLang.toUpperCase();
            if(label === 'ES') label = 'ESPAÑOL';
            else if(label === 'EN') label = 'INGLÉS';
            
            showFeedback(null, "Audio: " + label);
        }

        // --- CONTROL ---

        function changeChannel(offset) {
            previousChannelIndex = currentChannelIndex; // Guardar para Recall
            if (channelNumberBuffer !== "") {
                var target = parseInt(channelNumberBuffer) - 1;
                if (target >= 0 && target < canales.length) {
                    currentChannelIndex = target;
                    channelNumberBuffer = "";
                    cargarStream(true);
                }
            } else {
                currentChannelIndex = (currentChannelIndex + offset + canales.length) % canales.length;
                cargarStream(true);
            }
        }

        // Función Recall / Zapping (Volver al anterior)
        function recallChannel() {
            if (previousChannelIndex !== -1 && previousChannelIndex !== currentChannelIndex) {
                var temp = currentChannelIndex;
                currentChannelIndex = previousChannelIndex;
                previousChannelIndex = temp; // Permite alternar infinitamente entre dos canales
                cargarStream(true);
            }
        }

        function changeChannelManually() {
            var selectBox = document.getElementById("channelSelector");
            previousChannelIndex = currentChannelIndex;
            currentChannelIndex = parseInt(selectBox.value) - 1;
            channelNumberBuffer = "";
            cargarStream(true);
            document.getElementById("channelSelector").style.display = "none";
            document.getElementById("channelSelector").blur();
        }

        // --- UI ---

        function showFeedback(title, sub) {
            var con = document.getElementById("infoContainer");
            if(title) document.getElementById("channelName").innerText = title;
            if(sub) document.getElementById("audioInfo").innerText = sub;
            
            con.style.opacity = 1;
            clearTimeout(infoTimer);
            // Desaparece a los 2.5 segundos
            infoTimer = setTimeout(() => { con.style.opacity = 0; }, 2500);
        }

        function showChannelNumberOnScreen(num) {
            var el = document.getElementById("channelNum");
            el.innerText = num;
            el.style.display = "block";
            clearTimeout(timeoutId); 
            timeoutId = setTimeout(() => { el.style.display = "none"; }, 2000);
        }

        // --- TECLADO ---
        document.addEventListener("keydown", function(event) {
            var keyCode = event.keyCode;
            var sel = document.getElementById("channelSelector");
            
            // Evitar comportamiento por defecto de flechas si el selector no está activo
            if([37,38,39,40].includes(keyCode) && sel.style.display !== "block") {
                event.preventDefault();
            }

            if (keyCode === 13) { // Enter
                if (sel.style.display === "block") {
                    changeChannelManually();
                } else {
                    sel.style.display = "block"; 
                    sel.focus(); 
                }
            } 
            else if (keyCode === 37) { // Izquierda (Canal -)
                changeChannel(-1);
            } 
            else if (keyCode === 39) { // Derecha (Canal +)
                changeChannel(1);
            } 
            else if (keyCode === 38) { // Arriba (Audio Anterior)
                if(sel.style.display !== "block") changeAudioTrack(-1);
            } 
            else if (keyCode === 40) { // Abajo (Audio Siguiente)
                if(sel.style.display !== "block") changeAudioTrack(1);
            } 
            // Tecla RECALL Android (229) o Backspace (8)
            else if (keyCode === 229 || keyCode === 8) { 
                recallChannel();
            }
            else {
                // Números
                var pressedKey = parseInt(event.key);
                if (!isNaN(pressedKey) && pressedKey >= 0 && pressedKey <= 9) {
                    clearTimeout(timeoutId);
                    channelNumberBuffer += event.key;
                    showChannelNumberOnScreen(channelNumberBuffer);
                    
                    timeoutId = setTimeout(function() {
                        if (channelNumberBuffer !== "") {
                            previousChannelIndex = currentChannelIndex;
                            var target = parseInt(channelNumberBuffer) - 1;
                            if (target >= 0 && target < canales.length) {
                                currentChannelIndex = target;
                                cargarStream(true);
                            }
                            channelNumberBuffer = "";
                            document.getElementById("channelNum").style.display = "none";
                        }
                    }, 1500);
                }
            }
        });

        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>