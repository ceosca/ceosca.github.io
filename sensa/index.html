<!DOCTYPE html>
<html>
<head>
    <title>Reproductor de Audio y Video con Shaka Player</title>
    <!-- Librería de Shaka Player -->
    <script src="https://cdn.jsdelivr.net/npm/shaka-player@4.7.12/dist/shaka-player.ui.js"></script>
    <style>
        body {
            font-family: sans-serif;
            background-color: #f0f0f0;
            margin: 20px;
        }
        #video-container {
            margin-top: 20px;
            width: 800px;
            height: 450px;
            background-color: black;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        #video-player {
            width: 100%;
            height: 100%;
        }
        #controls {
            margin-top: 10px;
        }
        button, select {
            padding: 8px 12px;
            margin-right: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover, select:hover {
            background-color: #e9e9e9;
        }
        label {
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div>
        <label for="categorySelector">Selecciona una categoría:</label>
        <select id="categorySelector" onchange="updateChannelList()"></select>
    </div>
    <div style="margin-top: 10px;">
        <label for="channelSelector">Selecciona un canal:</label>
        <select id="channelSelector" onchange="cargarStream()"></select>
    </div>

    <!-- Contenedor para Shaka Player -->
    <div id="video-container">
        <video id="video-player" autoplay controls></video>
    </div>
    
    <div id="controls">
        <button onclick="playPause()">Play/Pausa</button>
        <button onclick="changeVolume(-10)">Bajar Volumen</button>
        <button onclick="changeVolume(10)">Subir Volumen</button>
        <button onclick="changeAudioTrack()">Cambiar Pista de Audio</button>
    </div>

    <script type='text/javascript'>
        var canales = [];
        var categorias = [];

        // Objeto Player adaptado desde tu archivo player.php
        const Player = {
            shakaPlayer: null,
            videoElement: null,

            init() {
                this.videoElement = document.getElementById('video-player');
                
                shaka.polyfill.installAll();
                if (shaka.Player.isBrowserSupported()) {
                    this.shakaPlayer = new shaka.Player(this.videoElement);
                    this.shakaPlayer.configure({
                        streaming: { 
                            followRedirects: true, 
                            lowLatencyMode: true, 
                            jumpLargeGaps: true 
                        },
                        manifest: { 
                            dash: { defaultPresentationDelay: 10 } 
                        }
                    });

                    // Filtro para manejar headers especiales en la URL, si los hubiera (ej: url|User-Agent=...)
                    this.shakaPlayer.getNetworkingEngine().registerRequestFilter((type, request) => {
                        if (type === shaka.net.NetworkingEngine.RequestType.MANIFEST || type === shaka.net.NetworkingEngine.RequestType.SEGMENT) {
                            const urlParts = request.uris[0].split('|');
                            request.uris[0] = urlParts[0];
                            if (urlParts.length > 1) {
                                for (let i = 1; i < urlParts.length; i++) {
                                    const headerParts = urlParts[i].split('=');
                                    if (headerParts.length === 2) {
                                        request.headers[headerParts[0]] = headerParts[1];
                                    }
                                }
                            }
                        }
                    });
                    
                    this.shakaPlayer.addEventListener('error', e => {
                        console.error('Error de Shaka Player:', e.detail);
                    });
                } else {
                    console.error('Shaka Player no es soportado por este navegador.');
                }
            },

            async play(channel) {
                if (!channel || !channel.url || !this.shakaPlayer) {
                    console.error("No se puede reproducir: falta canal, URL o el reproductor no está inicializado.");
                    return;
                }

                let manifestUri = channel.url;
                let drmConfig = {};

                // Construir la configuración DRM para clearkey desde tu formato de JSON
                if (channel.keyId && channel.key) {
                    drmConfig = {
                        clearKeys: {
                            // Shaka espera el KID sin guiones
                            [channel.keyId.replace(/-/g, '')]: channel.key.replace(/-/g, '')
                        }
                    };
                }

                try {
                    await this.shakaPlayer.unload();
                    this.shakaPlayer.configure({ drm: drmConfig });
                    await this.shakaPlayer.load(manifestUri);
                    console.log(`Reproduciendo: ${channel.nombre}`);
                } catch (e) {
                    console.error(`Error al cargar ${channel.nombre}:`, e);
                }
            },

            togglePlayPause() {
                if (!this.videoElement) return;
                if (this.videoElement.paused) {
                    this.videoElement.play();
                } else {
                    this.videoElement.pause();
                }
            },
            
            cycleAudioTrack() {
                if (!this.shakaPlayer || !this.shakaPlayer.isLoaded()) return;

                const audioTracks = this.shakaPlayer.getAudioLanguagesAndRoles();
                if (audioTracks.length <= 1) { 
                    console.log('No hay pistas de audio alternativas.');
                    return; 
                }

                const activeTracks = this.shakaPlayer.getVariantTracks().filter(t => t.active && t.type === 'variant');
                const currentTrack = activeTracks.length > 0 ? activeTracks[0] : null;

                if (!currentTrack) {
                    console.log('No se pudo determinar la pista actual.');
                    return;
                }
                
                const currentIndex = audioTracks.findIndex(t => t.language === currentTrack.language && t.role === currentTrack.roles[0]);
                const nextIndex = (currentIndex + 1) % audioTracks.length;
                const nextTrack = audioTracks[nextIndex];
                
                this.shakaPlayer.selectAudioLanguage(nextTrack.language, nextTrack.role);
                
                const langNames = new Intl.DisplayNames(['es'], { type: 'language' });
                const friendlyName = langNames.of(nextTrack.language) || nextTrack.language;
                console.log(`Audio cambiado a: ${friendlyName.charAt(0).toUpperCase() + friendlyName.slice(1)}`);
            }
        };

        // --- Lógica de la interfaz (mantenida del archivo original) ---

        function inicializarAplicacion() {
            Player.init(); // Inicializa Shaka Player
            fetch('/canales/db.json')
                .then(response => response.json())
                .then(data => {
                    canales = data;
                    categorias = obtenerCategoriasOrdenadas();
                    cargarCategorias();
                    updateChannelList();
                })
                .catch(error => console.error('Error al cargar el JSON:', error));
        }

        function cargarCategorias() {
            var selectBox = document.getElementById("categorySelector");
            categorias.forEach(function(categoria) {
                var option = document.createElement("option");
                option.text = categoria;
                selectBox.add(option);
            });
        }

        function obtenerCategoriasOrdenadas() {
            var categoriasSet = new Set();
            canales.forEach(function(canal) {
                categoriasSet.add(canal.categoria);
            });
            return Array.from(categoriasSet).sort();
        }

        function updateChannelList() {
            var selectedCategory = document.getElementById("categorySelector").value;
            var channelSelector = document.getElementById("channelSelector");
            channelSelector.innerHTML = "";
            
            var filteredChannels = canales.filter(function(canal) {
                return canal.categoria === selectedCategory;
            });
            
            filteredChannels.sort(function(a, b) {
                return a.nombre.localeCompare(b.nombre);
            });
            
            filteredChannels.forEach(function(canal) {
                var option = document.createElement("option");
                option.text = canal.nombre;
                option.value = JSON.stringify(canal);
                channelSelector.add(option);
            });
            
            if (filteredChannels.length > 0) {
                cargarStream();
            }
        }

        function cargarStream() {
            var selectBox = document.getElementById("channelSelector");
            if (selectBox.value) {
                var canalSeleccionado = JSON.parse(selectBox.value);
                Player.play(canalSeleccionado);
            }
        }

        // --- Funciones de los botones de control ---

        function playPause() {
            Player.togglePlayPause();
        }

        function changeVolume(amount) {
            if (!Player.videoElement) return;
            // El volumen del elemento de video va de 0.0 a 1.0
            let currentVolume = Player.videoElement.volume;
            let newVolume = currentVolume + (amount / 100);
            
            // Asegurarse de que el volumen se mantenga entre 0 y 1
            newVolume = Math.max(0, Math.min(1, newVolume));
            
            Player.videoElement.volume = newVolume;
            console.log(`Volumen ajustado a: ${Math.round(newVolume * 100)}%`);
        }

        function changeAudioTrack() {
            Player.cycleAudioTrack();
        }
        
        // Iniciar la aplicación una vez que el DOM esté listo
        document.addEventListener('DOMContentLoaded', inicializarAplicacion);

    </script>
</body>
</html>