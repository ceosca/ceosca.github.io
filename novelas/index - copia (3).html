<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Reproductor de Novelas</title>
</head>
<body>
<h1 id="novela-titulo"></h1>
<div>
  <p id="novela-genero"></p>
  <p id="novela-anio"></p>
  <p id="novela-pais"></p>
  <p id="novela-reparto"></p>
  <p id="novela-sinopsis"></p>
</div>
<hr>

<div>
<h2>Selecciona una novela...</h2>

  <label for="pais-list" accesskey="p">Selecciona el país:</label>
  <select id="pais-list" aria-label="Lista de países" accesskey="p"></select>

  <label for="novela-list" accesskey="n">Selecciona la novela:</label>
  <select id="novela-list" aria-label="Lista de novelas" accesskey="n"></select>

  <label for="season-list" accesskey="t">Selecciona la temporada:</label>
  <select id="season-list" aria-label="Lista de temporadas" accesskey="t"></select>

  <label for="chapter-list" accesskey="c">Selecciona el capítulo a reproducir:</label>
  <select id="chapter-list" aria-label="Lista de capítulos" accesskey="c"></select>

<h3>Reproductor...</h3>
  <button id="play-pause" title="Reproducir (Alt+K)" aria-label="Reproducir" accesskey="k">Reproducir</button>

  <p id="speak-text" onclick="speak(this.textContent);" accesskey="i"></p>
  <div id="alert" aria-live="assertive"></div>

  <button id="backward" title="Retroceder 10 segundos (Alt+J)" aria-label="Retroceder" accesskey="j">Retroceder</button>
  <button id="forward" title="Avanzar 10 segundos (Alt+L)" aria-label="Avanzar" accesskey="l">Avanzar</button>

  <button id="volume-up" title="Subir volumen (Alt+U)" aria-label="Subir volumen" accesskey="u">Subir volumen</button>
  <button id="volume-down" title="Bajar volumen (Alt+O)" aria-label="Bajar volumen" accesskey="o">Bajar volumen</button>
  <input type="checkbox" id="autoplay" aria-label="Reproducir automáticamente el siguiente capítulo" accesskey="s" checked>
</div>

<audio id="repro" src="" type="audio/mpeg"></audio>

<script>
  const audio = document.getElementById("repro");
  const novelaList = document.getElementById("novela-list");
  const chapterList = document.getElementById("chapter-list");
  const seasonList = document.getElementById("season-list");
  const playPauseButton = document.getElementById("play-pause");
  const paisList = document.getElementById("pais-list");

  let novelasData = [];
  let paises = [];
  let novelaSeleccionada; // Store the selected novela
  let temporadaSeleccionada; // Store the selected temporada
  let paisSeleccionado;


  // Cargar el archivo JSON con las novelas
  fetch('https://ceosca.github.io/novelas/novelas.json')
    .then(response => response.json())
    .then(data => {
      novelasData = data.novelas;
      cargarPaises();
    });

  function cargarPaises() {
    // Obtener todos los países únicos de las novelas
    paises = [...new Set(novelasData.map(novela => novela.pais_origen))];

    // Limpiar y llenar la lista de países
    paisList.innerHTML = "";
    paises.forEach((pais, index) => {
      const option = document.createElement("option");
      option.text = pais;
      option.value = pais;  // Usamos el nombre del país como valor
      paisList.add(option);
    });

    // Cargar las novelas del primer país por defecto
    paisList.selectedIndex = 0;
    paisSeleccionado = paisList.value;
    cargarNovelas();
  }


  function cargarNovelas() {
    paisSeleccionado = paisList.value;
    const novelasFiltradas = novelasData.filter(novela => novela.pais_origen === paisSeleccionado);

    novelaList.innerHTML = "";
    novelasFiltradas.forEach((novela, index) => {
      const option = document.createElement("option");
      option.text = novela.titulo;
      option.value = index; // Usar el índice dentro del array filtrado
      novelaList.add(option);
    });

    // Cargar la primera novela del país por defecto
    novelaList.selectedIndex = 0;
    cargarTemporadas();
  }

  function cargarTemporadas() {
    paisSeleccionado = paisList.value;
    const novelasFiltradas = novelasData.filter(novela => novela.pais_origen === paisSeleccionado);
    const novelaIndex = novelaList.value;
    novelaSeleccionada = novelasFiltradas[novelaIndex];

    document.getElementById("novela-titulo").textContent = novelaSeleccionada.titulo;
    document.getElementById("novela-genero").textContent = `Género: ${novelaSeleccionada.genero}`;
    document.getElementById("novela-anio").textContent = `Año: ${novelaSeleccionada.anio}`;
    document.getElementById("novela-pais").textContent = `País de origen: ${novelaSeleccionada.pais_origen}`;
    document.getElementById("novela-reparto").textContent = `Reparto: ${novelaSeleccionada.reparto.join(', ')}`;
    document.getElementById("novela-sinopsis").textContent = `Sinopsis: ${novelaSeleccionada.sinopsis}`;

    seasonList.innerHTML = "";
    novelaSeleccionada.temporadas.forEach((temporada, index) => {
      const option = document.createElement("option");
      option.text = temporada.nombre;
      option.value = index;
      seasonList.add(option);
    });

    seasonList.selectedIndex = 0;
    cargarCapitulos();
  }

  function cargarCapitulos() {
    paisSeleccionado = paisList.value;
    const novelasFiltradas = novelasData.filter(novela => novela.pais_origen === paisSeleccionado);
    const novelaIndex = novelaList.value;
    novelaSeleccionada = novelasFiltradas[novelaIndex];
    const temporadaIndex = seasonList.value;
    temporadaSeleccionada = novelaSeleccionada.temporadas[temporadaIndex];

    chapterList.innerHTML = "";
    for (let i = 1; i <= temporadaSeleccionada.capitulos; i++) {
      const option = document.createElement("option");
      option.text = `Capítulo ${i}`;
      option.value = i;
      chapterList.add(option);
    }

    chapterList.selectedIndex = 0;
    restaurarProgreso(); // Restore progress when chapter list changes
    setChapter();
  }

  function setChapter() {
    paisSeleccionado = paisList.value;
    const novelasFiltradas = novelasData.filter(novela => novela.pais_origen === paisSeleccionado);
    const novelaIndex = novelaList.value;
    novelaSeleccionada = novelasFiltradas[novelaIndex];
    const temporadaIndex = seasonList.value;
    temporadaSeleccionada = novelaSeleccionada.temporadas[temporadaIndex];
    const capituloSeleccionado = chapterList.value;
    audio.src = `${temporadaSeleccionada.enlace_base}${capituloSeleccionado}.m4a`;
    audio.load();

    const progreso = obtenerProgreso();
    if(progreso && progreso.capitulo == capituloSeleccionado){
        audio.currentTime = progreso.tiempo;
    }

  }


  function updatePlayPauseButton(title, ariaLabel) {
    playPauseButton.setAttribute("title", `${title} (Alt+K)`);
    playPauseButton.setAttribute("aria-label", ariaLabel);
    playPauseButton.textContent = title;
  }

  function playPause() {
    if (audio.paused) {
      audio.play();
      updatePlayPauseButton("Pausar", "Pausar");
    } else {
      audio.pause();
      updatePlayPauseButton("Reproducir", "Reproducir");
    }
  }

  function obtenerProgreso(){
    const novelaTitulo = document.getElementById("novela-titulo").textContent;
    const progresoGuardado = localStorage.getItem(novelaTitulo);
    return progresoGuardado ? JSON.parse(progresoGuardado) : null;
  }

  function guardarProgreso() {
      const novelaTitulo = document.getElementById("novela-titulo").textContent;
      const capitulo = chapterList.value;
      const tiempo = audio.currentTime;

      const progreso = {
        capitulo: capitulo,
        tiempo: tiempo
      };

      localStorage.setItem(novelaTitulo, JSON.stringify(progreso));
  }

  function restaurarProgreso() {
    const progreso = obtenerProgreso();
      if(progreso){
          chapterList.value = progreso.capitulo;
      }
  }

  playPauseButton.addEventListener("click", playPause);
  chapterList.addEventListener("change", setChapter);
  seasonList.addEventListener("change", cargarCapitulos);
  novelaList.addEventListener("change", cargarTemporadas);
  paisList.addEventListener("change", cargarNovelas);

  audio.addEventListener('pause', guardarProgreso);
  audio.addEventListener('play', function() {
      updatePlayPauseButton("Pausar", "Pausar");
  });

  // Save progress every 5 seconds
  setInterval(guardarProgreso, 5000);
</script>
</body>
</html>