<!DOCTYPE html>
<html>
<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.3.1/shaka-player.compiled.js"></script>
</head>
<body>
    <div id="playerContainer"></div>
    <div id="controls">
        <select id="channelSelector" style="display:none;" onchange="changeChannelManually()">
        </select>
    </div>
    <script>
        var player = null;
        var channels = [];
        var currentChannelIndex = null;
        var channelNumberBuffer = "";
        var timeoutId = null;

        fetch('https://ceosca.github.io/canales.json')
            .then(response => response.json())
            .then(data => {
                channels = data;
                loadOptions();
                loadStream();
            })
            .catch(error => console.error('Error loading JSON:', error));

        function loadOptions() {
            var selectBox = document.getElementById("channelSelector");
            channels.forEach(function(channel, index) {
                var option = document.createElement("option");
                option.text = channel.nombre;
                option.value = index;
                selectBox.add(option);
            });
            selectBox.selectedIndex = 0;
        }

        function loadStream() {
            if (!channels || channels.length === 0) {
                console.error('No channels available.');
                return;
            }

            if (currentChannelIndex === null || currentChannelIndex < 0 || currentChannelIndex >= channels.length) {
                console.error('Invalid channel index.');
                return;
            }

            var selectedChannel = channels[currentChannelIndex];

            if (!selectedChannel || !selectedChannel.url) {
                console.error('Invalid selected channel.');
                return;
            }

            var manifestUri = selectedChannel.url;

            var config = {};

            if (selectedChannel.tipo_cifrado === "oct") {
                config.drm = {
                    servers: {
                        'com.widevine.alpha': selectedChannel.url
                    },
                    clearKeys: {
                        [selectedChannel.keyId]: selectedChannel.key
                    }
                };
            }

            player = new shaka.Player(document.getElementById('playerContainer'));
            player.configure(config);
            player.load(manifestUri).then(function() {
                console.log('Stream loaded successfully');
            }).catch(onError);
        }

        function changeChannel(offset) {
            if (channelNumberBuffer !== "") {
                currentChannelIndex = parseInt(channelNumberBuffer);
                channelNumberBuffer = "";
                loadStream();
            } else {
                currentChannelIndex = (currentChannelIndex + offset + channels.length) % channels.length;
                loadStream();
            }
        }

        function changeChannelManually() {
            var selectBox = document.getElementById("channelSelector");
            currentChannelIndex = parseInt(selectBox.value);
            channelNumberBuffer = "";
            loadStream();
            hideSelector();
        }

        function hideSelector() {
            document.getElementById("channelSelector").style.display = "none";
        }

        document.addEventListener("keydown", function(event) {
            var keyCode = event.keyCode;
            if (keyCode === 13) {
                document.getElementById("channelSelector").style.display = "block";
                document.getElementById("channelSelector").focus();
            } else if (keyCode === 37) {
                changeChannel(-1);
            } else if (keyCode === 39) {
                changeChannel(1);
            } else {
                var pressedKey = parseInt(event.key);
                if (!isNaN(pressedKey) && pressedKey >= 0 && pressedKey <= 9) {
                    clearTimeout(timeoutId);
                    channelNumberBuffer += event.key;
                    timeoutId = setTimeout(function() {
                        if (channelNumberBuffer !== "") {
                            currentChannelIndex = parseInt(channelNumberBuffer);
                            channelNumberBuffer = "";
                            loadStream();
                        }
                    }, 1000);
                }
            }
        });

        function onError(event) {
            console.error('Error code', event.detail.code, 'object', event.detail.data);
        }
    </script>
</body>
</html>
