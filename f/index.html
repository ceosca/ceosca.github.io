<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Series</title>
    <style>
        html,
        body {
            margin: 0;
            padding: 0;
            box-sizing: border-box
        }

        :root {
            --pc: #4CAF50;
            --pcd: #3e8e41;
            --tc: #333;
            --bc: #f4f4f4;
            --w: #fff;
            --s: 0 0 5px rgba(0, 0, 0, .1);
            --fo: 3px solid #007bff;
            --foo: 2px
        }

        body {
            font-family: Arial, sans-serif;
            background-color: var(--bc);
            font-size: 1.2em;
            line-height: 1.6;
            color: var(--tc)
        }

        h2 {
            font-size: 1.8em;
            margin-bottom: .5em
        }

        .c {
            width: 95%;
            margin: 10px auto;
            background-color: var(--w);
            padding: 15px;
            box-shadow: var(--s)
        }

        .b {
            padding: 12px 18px;
            border: none;
            cursor: pointer;
            border-radius: 5px;
            transition: background-color .2s ease, box-shadow .2s ease;
            font-size: 1em;
            background-color: var(--pc);
            color: var(--w);
            margin-top: 5px;
        }

        .b:hover,
        .b:focus {
            box-shadow: var(--s);
            outline: none
        }

        .bp:hover,
        .bp:focus {
            background-color: var(--pcd)
        }

        .sl {
            list-style-type: none;
            padding: 0
        }

        .sl li {
            margin-bottom: 10px
        }

        .sl button {
            width: 100%;
            text-align: left;
            font-size: 1.1em;
            display: block
        }

        .m {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, .7)
        }

        .mc {
            background-color: var(--w);
            padding: 20px;
            border: 1px solid #888;
            width: 100%;
            position: relative;
            border-radius: 10px;
        }
        
        .m .mc {
             margin: 15% auto;
             padding-top: 60px;
             padding-bottom: 70px;
             width: 90%;
        }

        .fh {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background-color: var(--w);
            padding: 10px 20px;
            z-index: 2;
            box-shadow: 0 2px 5px rgba(0, 0, 0, .2);
            display: flex;
            justify-content: flex-end
        }

        .fp {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: #f0f0f0;
            padding: 10px;
            text-align: center;
            z-index: 2;
            box-shadow: 0 -2px 5px rgba(0, 0, 0, .2);
            display: flex;
            justify-content: space-around;
            align-items: center;
            flex-wrap: wrap
        }

        .fp button {
            background-color: #555;
            color: var(--w);
            transition: background-color .3s;
            font-size: .9em;
            padding: 8px 12px;
            margin-bottom: 5px
        }

        .fp button:hover {
            background-color: #777
        }

        .fp #ti,
        .fp #ci {
            font-size: .8em;
            color: var(--tc);
            width: 100%;
            text-align: center
        }

        .lc,
        .ec,
        .tc {
            margin-top: 1em;
            width: 100%;
        }
        .tc { 
             margin-bottom: 1em; 
        }

        .lc label,
        .ec label,
        .tc label {
            display: block;
            margin-bottom: .5em;
            font-size: 1.1em
        }

        .lc select,
        .ec select,
        .tc select {
            width: 100%;
            padding: 10px;
            font-size: 1em;
            border: 1px solid #ccc;
            border-radius: 5px;
            margin-bottom: 1em;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 10px top 50%;
            background-size: 1.5em
        }

        .h {
            display: none !important
        }

        *:focus {
            outline: var(--fo);
            outline-offset: var(--foo)
        }

        @media (max-width:600px) {

            body {
                font-size: 1.1em
            }

            h2 {
                font-size: 1.5em
            }

            .c {
                padding: 10px
            }

            .sl button {
                padding: 12px 15px;
                font-size: 1em
            }

            .m .mc {
                margin: 20% auto
            }
        }

        #as {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
            text-align: center;
        }
        #as p {
            margin-bottom: 10px;
        }

        #cw {
            margin-bottom: 20px
        }

        #cw h2 {
            font-size: 1.5em;
            margin-bottom: 10px
        }

        #cw ul {
            list-style: none;
            padding: 0
        }

        #cw li {
            margin-bottom: 5px
        }

        #cw li button {
            margin-right: 5px
        }

        #usac {
            margin-bottom: 20px;
        }

        #usac h2 {
            font-size: 1.5em; 
            margin-bottom: 10px;
        }

        #selector-series {
            text-align: center;
            margin-bottom: 20px;
        }

        #selector-series h2 {
            margin-bottom: 10px;
        }

        #selector-series ul {
            list-style: none;
            padding: 0;
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
        }

        #selector-series li {
            margin: 5px 10px;
        }

        #selector-series a {
            text-decoration: none;
            color: var(--pc);
            font-weight: bold;
            padding: 8px 12px;
            border: 2px solid var(--pc);
            border-radius: 5px;
            transition: background-color 0.2s ease, color 0.2s ease;
            display: block;
        }

        #selector-series a:hover {
            background-color: var(--pc);
            color: var(--w);
        }
    </style>
</head>

<body>
    <div class="c">
        <div id="as">
            <p>¡te doy la bienvenida! Puedes explorar y escuchar series sin iniciar sesión. Si deseas guardar tu progreso y continuar escuchando más tarde donde lo dejaste, </p>
            <button id="gsi" class="b">Inicia sesión con Google</button>
            <button id="so" class="b h">Cerrar sesión</button>
        </div>

        <div id="selector-series">
            <h2>¿Qué quieres escuchar?</h2>
            <ul>
                <li><a href="#" id="en-espanol">Series en español original</a></li>
                <li><a href="#" id="con-doblaje">Series con doblaje</a></li>
            </ul>
        </div>

        <div id="mc">
            <main>
                <div id="cw" class="h">
                    <h2>Continuar escuchando</h2>
                    <ul id="cwl"></ul>
                </div>

                <div id="usac">
                    <h2>Últimas Series Agregadas</h2>
                    <ul id="usal" class="sl"></ul> 
                </div>
                
                <div id="coc"></div>
            </main>
        </div>
    </div>

    <div id="sM" class="m" aria-hidden="true" role="dialog" aria-labelledby="modal-title">
        <div class="mc" tabindex="-1">
            <header class="fh">
                <h2 id="modal-title">Detalles de la Serie</h2>
                <button class="close b bp" id="cb" aria-label="Regresar">Regresar</button>
            </header>
            <main>
                <div id="si" aria-live="polite"></div>
                <section class="tc h" id="tasc">
                    <label for="t">Temporada:</label>
                    <select id="t"></select>
                </section>
            </main>
            <audio id="ap">Audio no soportado.</audio>
            <h2>Reproductor</h2>
            <footer class="fp">
                <div id="ci"></div>
                <div id="ti"></div>
                <button id="ppb" class="b" aria-label="Reproducir/Pausar">Reproducir</button>
                <button id="fb" class="b" aria-label="Avanzar 15 segundos">Avanzar</button>
                <button id="bb" class="b" aria-label="Retroceder 15 segundos">Retroceder</button>
                <button id="reb" class="b" aria-label="Reiniciar episodio">Reiniciar episodio</button>
                <button id="ncb" class="b" aria-label="Siguiente episodio">Siguiente episodio</button>
                <button id="pcb" class="b" aria-label="Episodio anterior">Episodio anterior</button>
                <button id="ivb" class="b" aria-label="Subir volumen">Subir volumen</button>
                <button id="dvb" class="b" aria-label="Bajar volumen">Bajar volumen</button>
                <section class="ec" id="easc">
                    <label for="c">Capítulo:</label>
                    <select id="c"></select>
                </section>
                <section class="lc h" id="lasc">
                    <label for="l">Pista de audio:</label>
                    <select id="l"></select>
                </section>
            </footer>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, getDoc, query, where, getDocs, serverTimestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-firestore.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-auth.js";

        const fC = { apiKey: "AIzaSyAGzPA5b5P1NofFZtbBvGpuYE3tVR-JaS0", authDomain: "pfdsuaaug.firebaseapp.com", projectId: "pfdsuaaug", storageBucket: "pfdsuaaug.firebasestorage.app", messagingSenderId: "701797222900", appId: "1:701797222900:web:01836d45db1b35be2bd1a1" },
            app = initializeApp(fC),
            db = getFirestore(app),
            auth = getAuth(app),
            gP = new GoogleAuthProvider,
            gSI = document.getElementById('gsi'), 
            sO = document.getElementById('so'),   
            EEL = document.getElementById('en-espanol'),
            CDL = document.getElementById('con-doblaje'),
            SDP1 = 'https://dl.dropbox.com/',
            SDP2 = 'scl/fi/q5gd1j2lor3fbe6dtv15c/series.json?rlkey=vpgalrx1bbqhjy513q9qr9jvp&dl=1',
            SDP3 = 'scl/fi/725dxvrb9i69xd4td620v/doblaje.json?rlkey=4elbmhb2ruq76jsi4ohfcp7we&dl=1',
            A = document.getElementById('ap'),
            MCD = document.getElementById('mc'), 
            M = document.getElementById("sM"),    
            CBC = document.getElementById("cb"),  
            PB = document.getElementById('ppb'),  
            CS = document.getElementById('c'),    
            LC = document.getElementById('lasc'), 
            LS = document.getElementById('l'),    
            CI = document.getElementById('ci'),   
            TI = document.getElementById('ti'),   
            CWL = document.getElementById('cwl'), 
            TS = document.getElementById('t'),    
            SSD = document.getElementById('selector-series'),
            USAL = document.getElementById('usal'),
            REB = document.getElementById('reb');

        let TII, IP = !1, CSDL = [], CLI = 0, CCL = 0, CPT = 0, S, SDJ = SDP1 + SDP2, TAS = [];

        const GNB = snc => snc.split(', temporada')[0].trim();
        const MCGLTSL = (nbs, cgi, tasl) => {
            const semsb = tasl.filter(s => GNB(s.nombre) === nbs);
            const semsbo = OTS(semsb);
            let cgc = 0;
            for (const stp of semsbo) {
                const nce = stp.capitulos.length;
                if (cgi < cgc + nce) {
                    return { stp, ccl: cgi - cgc };
                }
                cgc += nce;
            }
            return semsbo.length > 0 ? { stp: semsbo[0], ccl: 0 } : { stp: null, ccl: 0 };
        };
        const MTSLCG = (ste, ccl, tasl) => {
            const nbs = GNB(ste.nombre);
            const semsb = tasl.filter(s => GNB(s.nombre) === nbs);
            const semsbo = OTS(semsb);
            let cgi = 0;
            for (const stp of semsbo) {
                if (stp.nombre === ste.nombre) {
                    cgi += ccl;
                    return cgi;
                }
                if (stp.capitulos) cgi += stp.capitulos.length;
            }
            return ccl;
        };

        const sWGi = async () => { try { await signInWithPopup(auth, gP); } catch (e) {} };
        const sOG = async () => { try { await signOut(auth); } catch (e) {} };

        onAuthStateChanged(auth, u => {
            const ast = document.querySelector('#as p');
            if (u) {
                gSI.classList.add('h'); sO.classList.remove('h');
                if (ast) ast.textContent = `¡Hola de nuevo! Tu progreso se guardará automáticamente.`;
            } else {
                gSI.classList.remove('h'); sO.classList.add('h');
                if (ast) ast.textContent = `¡Bienvenido/a! Puedes explorar y escuchar series sin iniciar sesión. Si deseas guardar tu progreso y continuar escuchando más tarde donde lo dejaste, por favor:`;
            }
            UCW();
        });

        gSI.addEventListener('click', sWGi);
        sO.addEventListener('click', sOG);

        const FT = t => { const m = Math.floor(t / 60), s = Math.floor(t % 60); return `${PZ(m)}:${PZ(s)}` };
        const PZ = n => (n < 10 ? '0' : '') + n;
        
        const SP = async () => {
            if (!S || !auth.currentUser) return;
            const t = A.currentTime;
            const nbs = GNB(S.nombre);
            const cgi = MTSLCG(S, CCL, TAS);
            try {
                const u = auth.currentUser;
                const p = { serieNombreBase: nbs, capituloGlobalIndex: cgi, tiempo: t, idiomaIndex: CLI, userId: u.uid, ultimaActualizacion: serverTimestamp() };
                await setDoc(doc(db, "progresoSeries", `${u.uid}_${nbs}`), p);
                UCW();
            } catch (e) {}
        };

        const LP = async (nbs) => {
            if (!auth.currentUser || !TAS.length) return !1;
            try {
                const u = auth.currentUser;
                const dS = await getDoc(doc(db, "progresoSeries", `${u.uid}_${nbs}`));
                if (dS.exists()) {
                    const d = dS.data();
                    const { stp, ccl } = MCGLTSL(nbs, d.capituloGlobalIndex, TAS);
                    if (stp) {
                        S = stp;
                        CCL = ccl;
                        A.currentTime = d.tiempo;
                        CLI = d.idiomaIndex || 0;
                        
                        if (document.getElementById('tasc').classList.contains('h') === false && TS.options.length > 0) {
                           TS.value = S.nombre;
                        }
                        CS.value = CCL; 
                        LS.value = CLI;
                        UC();
                        return !0;
                    }
                }
                return !1;
            } catch (e) { return !1; }
        };

        const C = () => { 
            S && SP();
            M.style.display = "none"; M.setAttribute("aria-hidden", "true");
            A.pause(); A.src = '';
            MCD.classList.remove('h'); 
            clearInterval(TII); IP = !1; PB.textContent = 'Reproducir';
            CPT = A.currentTime; 
            disableFocusTrap(M); SSD.style.display = "block"; 
            document.getElementById('as').style.display = "block"; 
        };

        const O = s => { 
            S = s; 
            const nbs = GNB(S.nombre);
            IP = !1; CLI = 0; CCL = 0; CPT = 0; CSDL = [];
            
            LP(nbs).then((pc) => {
                if (pc) {
                    CPT = A.currentTime; 
                } else {
                    S = s; 
                    CCL = 0; A.currentTime = 0; CPT = 0; CLI = 0;
                    if (TS.options.length > 0 && Array.from(TS.options).some(opt => opt.value === S.nombre)) {
                        TS.value = S.nombre;
                    }
                }
                LI(S); LL(S); LCF(S);
                A.play().catch(e => {}); IP = true; PB.textContent = 'Pausar';
            });

            MCD.classList.add('h'); 
            M.style.display = "block"; M.setAttribute("aria-hidden", "false");
            document.querySelector('#sM .mc').focus();
            enableFocusTrap(M); SSD.style.display = "none"; 
            document.getElementById('as').style.display = "none"; 
        };

        const FD = async () => {
            try {
                const t = await fetch(SDJ);
                if (!t.ok) throw new Error(`Error! Status: ${t.status}`);
                const e = await t.json();
                TAS = e.series; 
                return TAS;
            } catch (t) { TAS = []; return []; }
        };

        const OTS = (a) => ([...a].sort((x, y) => { 
            const gtn = (nm) => { 
                const p = nm.split(', temporada ');
                if (p.length > 1) { const n = parseInt(p[1]); return isNaN(n) ? Infinity : n; }
                return 1; 
            };
            const nX = gtn(x.nombre), nY = gtn(y.nombre);
            return nX !== nY ? nX - nY : x.nombre.localeCompare(y.nombre);
        }));

        const RCAS = sa => { 
            const t = document.getElementById('coc');
            t.innerHTML = "";
            if (!sa || sa.length === 0) {
                t.innerHTML = "<p>No hay series disponibles para esta selección.</p>";
                return;
            }
            const sag = {}; 
            sa.forEach(se => { const nb = GNB(se.nombre); sag[nb] || (sag[nb] = []); sag[nb].push(se); });
            const pos = [...new Set(sa.map(se => se.pais_origen))].sort(); 
            pos.forEach(po => {
                const h2 = document.createElement('h2'); h2.textContent = po; t.appendChild(h2);
                const ul = document.createElement('ul'); ul.classList.add('sl');
                Object.keys(sag).sort((a, b) => a.localeCompare(b, 'es', { sensitivity: 'base' })).forEach(nb => {
                    const sd = sag[nb].filter(se => se.pais_origen === po); 
                    if (sd.length > 0) {
                        const li = document.createElement('li'), btn = document.createElement('button');
                        btn.textContent = nb;
                        btn.addEventListener('click', () => {
                            const sds = OTS(sd); const pt = sds[0]; 
                            O(pt);
                            sds.length > 1 ? LT(sds, pt.nombre) : document.getElementById('tasc').classList.add('h');
                        });
                        btn.setAttribute('tabindex', '0'); btn.classList.add('b');
                        li.appendChild(btn); ul.appendChild(li);
                    }
                });
                t.appendChild(ul);
            });
            UCW();
        };
        
        const LUSA = (sa) => { 
            if (!USAL || !sa || sa.length === 0) { if(USAL) USAL.innerHTML = "<li>No hay series nuevas recientemente.</li>"; return; }
            USAL.innerHTML = ''; const u20 = sa.slice(-20).reverse(); 
            u20.forEach(si => { 
                const li = document.createElement('li'); const btn = document.createElement('button');
                btn.textContent = si.nombre; btn.classList.add('b');
                btn.addEventListener('click', () => {
                    const nb = GNB(si.nombre); 
                    const sg = TAS.filter(i => GNB(i.nombre) === nb); 
                    O(si); 
                    if (sg.length > 1) { const so = OTS(sg); LT(so, si.nombre); } 
                    else { document.getElementById('tasc').classList.add('h'); }
                });
                li.appendChild(btn); USAL.appendChild(li);
            });
        };

        const LT = (sa, stn) => { 
            TS.innerHTML = ''; document.getElementById('tasc').classList.remove('h');
            sa.forEach(se => { 
                const tn = se.nombre.split(', temporada ')[1]; 
                const opt = document.createElement('option');
                opt.value = se.nombre; opt.textContent = tn ? `Temporada ${tn}` : se.nombre; 
                TS.appendChild(opt);
            });
            if (stn) TS.value = stn;
            TS.onchange = e => { 
                const ss = TAS.find(se => se.nombre === e.target.value); 
                if (ss) {
                    S = ss; CCL = 0; CPT = 0; A.currentTime = 0;
                    LI(S); LL(S); LCF(S);
                    A.play().catch(err => {}); IP = true; PB.textContent = 'Pausar';
                }
            };
        };

        const LI = sd => { 
            const t = document.getElementById('si'); let rh = ''; 
            if (SDJ === SDP1 + SDP2 && sd.reparto) { rh = `<div><strong>Reparto:</strong> ${sd.reparto.join(", ")}</div>`;}
            S = sd; 
            t.innerHTML = `<h2>${sd.nombre}</h2><div><strong>Género:</strong> ${sd.genero}</div><div><strong>Año:</strong> ${sd.anio}</div>${rh}<div><strong>País:</strong> ${sd.pais_origen}</div><div><strong>Episodios:</strong> ${sd.cantidad_episodios}</div>${sd.sinopsis ? `<div><strong>Sinopsis:</strong> ${sd.sinopsis}</div>` : ''}`
        };
        
        const LL = sd => { 
            LS.innerHTML = '';
            sd.enlaces.length > 1 ? (sd.enlaces.forEach((t, e) => {
                const n = document.createElement('option'); n.value = e; n.textContent = t.idioma; LS.appendChild(n);
            }), LC.classList.remove('h')) : LC.classList.add('h');
            LS.value = CLI;
        };

        const LCF = sd => { 
            CS.innerHTML = ''; CSDL = sd.capitulos;
            CSDL.forEach((t, e) => { const n = document.createElement('option'); n.value = e; n.textContent = t.titulo; CS.appendChild(n); });
            CS.value = CCL; UC();
            A.src = sd.enlaces[CLI].enlace; A.load(); A.currentTime = CPT; 
            if (IP) A.play().catch(e => {});
            clearInterval(TII); UT(); TII = setInterval(UT, 1e3);
        };

        const UC = () => { CI.textContent = (CSDL && CSDL[CCL]) ? (IP ? `Reproduciendo: ${CSDL[CCL].titulo}` : `${CSDL[CCL].titulo}`) : "Cargando capítulo..."; };
        
        const UT = () => { 
            const t = A.currentTime; if (!CSDL || CSDL.length === 0) return; 
            const e = GCLI(t); if (e < 0 || e >= CSDL.length || !CSDL[e]) return; 
            const n = CSDL[e], i = n.inicio / 1e3, o = n.fin / 1e3, r = FT(t - i), c = FT(o - i);
            if (CSDL[CCL]) { CI.textContent = IP ? `Reproduciendo: ${CSDL[CCL].titulo}` : `${CSDL[CCL].titulo}`; }
            TI.textContent = `${r} / ${c}`;
        };

        const TP = () => { IP ? (A.pause(), IP = !1, PB.textContent = 'Reproducir', PB.setAttribute('aria-label', 'Reproducir')) : (A.play().catch(e => {}), IP = !0, PB.textContent = 'Pausar', PB.setAttribute('aria-label', 'Pausar')) };
        const F = () => { A.currentTime += 15 }; 
        const B = () => { A.currentTime -= 15 }; 
        const RE = () => { if (S && CSDL && typeof CCL !== 'undefined' && CSDL[CCL]) { A.currentTime = CSDL[CCL].inicio / 1000; if (!IP) { A.play().catch(e => {}); IP = true; PB.textContent = 'Pausar'; PB.setAttribute('aria-label', 'Pausar');} UC(); } };
        
        const PCC = () => { 
            CCL = parseInt(CS.value);
            if (CSDL && CSDL[CCL]) {
                A.currentTime = CSDL[CCL].inicio / 1e3;
                A.play().catch(e => {}); IP = !0; PB.textContent = 'Pausar'; PB.setAttribute('aria-label', 'Pausar');
                UC();
            }
        };
        
        const GCLI = t => { 
            let e = 0; if (!CSDL || CSDL.length === 0) return 0; 
            CSDL.forEach((n, i) => { if (n && typeof n.inicio !== 'undefined' && typeof n.fin !== 'undefined') { if (t >= n.inicio / 1e3 && t <= n.fin / 1e3) e = i; } });
            return e;
        };

        const PP = () => { let t = CCL; t > 0 && (t--, CS.value = t, PCC()) }; 
        const NP = () => { let t = CCL; t < CSDL.length - 1 && (t++, CS.value = t, PCC()) }; 
        const CLS = () => { CPT = A.currentTime; CLI = parseInt(LS.value); S && LCF(S) }; 
        const IV = () => { A.volume = Math.min(1, A.volume + .05) }; 
        const DV = () => { A.volume = Math.max(0, A.volume - .05) }; 
        
        const DCW = async nbs => { 
            if (!auth.currentUser) return;
            try { const u = auth.currentUser; await deleteDoc(doc(db, "progresoSeries", `${u.uid}_${nbs}`)); UCW(); } catch (e) {}
        };

        const UCW = async () => { 
            CWL.innerHTML = '';
            if (!auth.currentUser) { document.getElementById('cw').classList.add('h'); return; }
            document.getElementById('cw').classList.remove('h'); 
            try {
                const u = auth.currentUser;
                const q = query(collection(db, "progresoSeries"), where("userId", "==", u.uid), where("tiempo", ">", 10));
                const qS = await getDocs(q); const c = []; qS.forEach(d => c.push({ ...d.data(), id: d.id }));

                if (c.length === 0) { CWL.innerHTML = "<li>No tienes series para continuar escuchando.</li>"; return; }
                if (TAS.length === 0) await FD();
                if (TAS.length === 0) { CWL.innerHTML = "<li>Error al cargar datos de series para progreso.</li>"; return; }

                for (const t of c) {
                    const { stp, ccl } = MCGLTSL(t.serieNombreBase, t.capituloGlobalIndex, TAS);
                    if (stp && stp.capitulos && stp.capitulos[ccl]) { 
                        const cap = stp.capitulos[ccl], ini = cap.inicio / 1e3, fin = cap.fin / 1e3;
                        const durR = FT(fin - t.tiempo);
                        const li = document.createElement('li'), btn = document.createElement('button');
                        let tempNombre = stp.nombre.includes(', temporada ') ? `, ${stp.nombre.split(', temporada ')[1]}` : '';
                        btn.textContent = `${t.serieNombreBase}${tempNombre}, ${cap.titulo}, Restante: ${durR}`;
                        btn.addEventListener('click', () => { O(stp); });
                        btn.classList.add('b'); li.appendChild(btn);
                        const delB = document.createElement('button');
                        delB.textContent = 'Eliminar'; delB.classList.add('b'); delB.style.backgroundColor = '#f44336'; 
                        delB.addEventListener('click', (e) => { e.stopPropagation(); DCW(t.serieNombreBase) });
                        li.appendChild(delB); CWL.appendChild(li);
                    }
                }
                if (CWL.children.length === 0) { CWL.innerHTML = "<li>No tienes series para continuar escuchando.</li>"; }
            } catch (e) { CWL.innerHTML = "<li>Error al cargar tu progreso.</li>"; }
        };

        CBC.addEventListener('click', C);
        window.addEventListener('click', t => { t.target === M && C() });
        CS.addEventListener('change', () => { S && SP(); PCC() });
        A.addEventListener('pause', () => { if (S && M.style.display === "block") SP()});
        A.addEventListener('play', () => { IP = !0; PB.textContent = 'Pausar'; PB.setAttribute('aria-label', 'Pausar'); UC(); });
        A.addEventListener('ended', () => { NP(); });
        LS.addEventListener('change', CLS);
        PB.addEventListener('click', TP);
        document.getElementById('fb').addEventListener('click', F);
        document.getElementById('bb').addEventListener('click', B);
        REB.addEventListener('click', RE);
        document.getElementById('pcb').addEventListener('click', PP);
        document.getElementById('ncb').addEventListener('click', NP);
        document.getElementById('ivb').addEventListener('click', IV);
        document.getElementById('dvb').addEventListener('click', DV);
        
        const CSRS = () => { 
            FD().then(sd => { RCAS(sd); if (sd && sd.length > 0) LUSA(sd); UCW(); });
        };

        EEL.addEventListener('click', (e) => { e.preventDefault(); SDJ = SDP1 + SDP2; CSRS(); });
        CDL.addEventListener('click', (e) => { e.preventDefault(); SDJ = SDP1 + SDP3; CSRS(); });
        
        window.onload = () => { CSRS(); }; 

        setInterval(() => { M.style.display === "block" && S && IP && SP() }, 10000);

        function createFocusTrap(element) {
            let fe = element.querySelectorAll('a[href], button:not([disabled]), textarea:not([disabled]), input:not([disabled]), select:not([disabled])');
            if (fe.length === 0) return { destroy: () => {}, update: () => {} }; 
            let ffe = fe[0], lfe = fe[fe.length - 1];
            const kh = (e) => {
                const it = e.key === 'Tab' || e.keyCode === 9; if (!it) return;
                if (e.shiftKey) { if (document.activeElement === ffe) { lfe.focus(); e.preventDefault(); } } 
                else { if (document.activeElement === lfe) { ffe.focus(); e.preventDefault(); } }
            };
            element.addEventListener('keydown', kh);
            return {
                destroy: () => { element.removeEventListener('keydown', kh); },
                update: () => {
                    fe = element.querySelectorAll('a[href], button:not([disabled]), textarea:not([disabled]), input:not([disabled]), select:not([disabled])');
                    if (fe.length === 0) return; ffe = fe[0]; lfe = fe[fe.length - 1];
                }
            };
        }
        let cft = null;
        function enableFocusTrap(el) { if (cft) cft.destroy(); cft = createFocusTrap(el); }
        function disableFocusTrap() { if (cft) { cft.destroy(); cft = null; } }
    </script>
</body>
</html>