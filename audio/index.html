<!DOCTYPE html>
<html>
<head>
    <title>Reproductor de Audio de Streams</title>
    <script type='text/javascript' src="//ssl.p.jwpcdn.com/player/v/8.25.0/jwplayer.js"></script>
    <script type='text/javascript'>jwplayer.key='XSuP4qMl+9tK17QNb+4+th2Pm9AWgMO/cYH8CI0HGGr7bdjo'</script>
    <style>
        body {
            font-family: sans-serif;
            margin: 20px;
            background-color: #f4f4f4;
        }
        #player {
            width: 300px; /* Ancho mínimo para que se vea algo, aunque sea audio-only */
            height: 40px; /* Altura mínima para controles si se activaran */
            background-color: #000;
            color: #fff;
            text-align: center;
            line-height: 40px; /* Centrar verticalmente el texto CARGANDO */
            margin-bottom: 10px;
        }
        #controls {
            margin-top: 10px;
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        select {
            width: 100%;
            padding: 8px;
            margin-bottom: 15px;
            border-radius: 4px;
            border: 1px solid #ccc;
            box-sizing: border-box;
        }
        button {
            padding: 10px 15px;
            margin-right: 5px;
            border: none;
            border-radius: 4px;
            background-color: #007bff;
            color: white;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        .container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            max-width: 500px;
            margin: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <div>
            <label for="categorySelector">Selecciona una categoría:</label>
            <select id="categorySelector" onchange="updateChannelList()"></select>
        </div>
        <div>
            <label for="channelSelector">Selecciona un canal:</label>
            <select id="channelSelector" onchange="cargarStream()"></select>
        </div>
        <div id="player">CARGANDO REPRODUCTOR...</div>
        <div id="controls">
            <button onclick="playPause()">Play/Pausa</button>
            <button onclick="changeVolume(-10)">Bajar Volumen</button> <!-- Ajustado a -10 para que sea más notable -->
            <button onclick="changeVolume(10)">Subir Volumen</button>  <!-- Ajustado a +10 para que sea más notable -->
            <!-- Los botones de cambio de track de audio pueden no ser muy útiles para streams HLS simples,
                 pero los dejamos por si algún stream tuviera múltiples pistas de audio. -->
            <button onclick="changeAudioTrack(-1)">Track Anterior</button>
            <button onclick="changeAudioTrack(1)">Siguiente Track</button>
        </div>
    </div>

    <script type='text/javascript'>
        var playerInstance = null;
        var canales = [];
        var categorias = [];

        // Asegúrate de que la ruta a canales.json sea correcta
        fetch('canales.json') // Si está en el mismo directorio
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok ' + response.statusText);
                }
                return response.json();
            })
            .then(data => {
                canales = data;
                categorias = obtenerCategoriasOrdenadas();
                cargarCategorias();
                // La primera carga de canales se hará cuando se seleccione una categoría.
                // O podemos forzar la carga de la primera categoría:
                if (categorias.length > 0) {
                    document.getElementById("categorySelector").value = categorias[0];
                    updateChannelList();
                }
            })
            .catch(error => {
                console.error('Error al cargar el JSON de canales:', error);
                document.getElementById("player").textContent = "Error al cargar lista de canales.";
            });

        function cargarCategorias() {
            var selectBox = document.getElementById("categorySelector");
            selectBox.innerHTML = ""; // Limpiar opciones previas
            if (categorias.length === 0) {
                var option = document.createElement("option");
                option.text = "No hay categorías disponibles";
                option.disabled = true;
                selectBox.add(option);
                return;
            }
            categorias.forEach(function(categoria) {
                var option = document.createElement("option");
                option.text = categoria;
                option.value = categoria; // Usar el nombre de la categoría como valor
                selectBox.add(option);
            });
        }

        function obtenerCategoriasOrdenadas() {
            var categoriasSet = new Set();
            canales.forEach(function(canal) {
                 // Solo añadir categoría si hay al menos un canal válido en ella
                if (canal.url && canal.url.startsWith("http") && (canal.url.includes(".m3u8") || canal.url.includes(".mpd"))) {
                    categoriasSet.add(canal.categoria);
                }
            });
            return Array.from(categoriasSet).sort();
        }

        function updateChannelList() {
            var selectedCategory = document.getElementById("categorySelector").value;
            var channelSelector = document.getElementById("channelSelector");
            channelSelector.innerHTML = ""; // Limpiar opciones previas

            var filteredChannels = canales.filter(function(canal) {
                // Filtrar por categoría y por URL válida (que comience con http y contenga .m3u8 o .mpd)
                return canal.categoria === selectedCategory &&
                       canal.url &&
                       canal.url.startsWith("http") &&
                       (canal.url.includes(".m3u8") || canal.url.includes(".mpd"));
            });

            filteredChannels.sort(function(a, b) {
                return a.nombre.localeCompare(b.nombre);
            });

            if (filteredChannels.length === 0) {
                var option = document.createElement("option");
                option.text = "No hay canales disponibles en esta categoría";
                option.disabled = true;
                channelSelector.add(option);
                if(playerInstance) playerInstance.stop(); // Detener si no hay canales
                document.getElementById("player").textContent = "Seleccione un canal";
                return;
            }

            filteredChannels.forEach(function(canal) {
                var option = document.createElement("option");
                option.text = canal.nombre;
                option.value = JSON.stringify(canal); // Guardar el objeto canal completo
                channelSelector.add(option);
            });

            // Cargar el primer stream de la lista actualizada automáticamente
            if (filteredChannels.length > 0) {
                cargarStream();
            }
        }

        function cargarStream() {
            var selectBox = document.getElementById("channelSelector");
            if (!selectBox.value) { // Si no hay valor seleccionado (ej. "No hay canales...")
                if(playerInstance) playerInstance.remove(); // Limpiar instancia anterior
                document.getElementById("player").textContent = "No hay canal para reproducir.";
                return;
            }
            var selectedValue;
            try {
                selectedValue = JSON.parse(selectBox.value);
            } catch (e) {
                console.error("Error al parsear valor del canal:", e);
                document.getElementById("player").textContent = "Error en datos del canal.";
                return;
            }


            if (!selectedValue || !selectedValue.url || !selectedValue.url.startsWith("http")) {
                 console.warn("URL inválida o no seleccionada:", selectedValue);
                 if(playerInstance) playerInstance.stop();
                 document.getElementById("player").textContent = "URL de stream inválida.";
                 return;
            }
            
            document.getElementById("player").textContent = "CARGANDO STREAM...";


            var streamType = selectedValue.url.includes(".mpd") ? "mpd" : "hls";

            var config = {
                playlist: [{
                    title: selectedValue.nombre || "Audio Stream",
                    sources: [{
                        file: selectedValue.url,
                        type: streamType // Dinámico HLS o MPD
                    }]
                }],
                width: "100%", // Puede ser % o px
                height: 40,    // Altura mínima para mostrar algo
                autostart: true,
                audioOnly: true, // Importante para M3U8 de solo audio
                visualPlaylist: false,
                controls: true // Activar controles básicos de JWPlayer, aunque tengamos los nuestros
            };
            
            // Configuración DRM (Clearkey) condicional
            if (selectedValue.keyId && selectedValue.key) {
                config.drm = {
                    clearkey: {
                        keyId: selectedValue.keyId,
                        key: selectedValue.key
                    }
                };
            }
            
            // Si ya existe una instancia, la removemos antes de crear una nueva
            if (playerInstance) {
                playerInstance.remove();
            }
            playerInstance = jwplayer("player").setup(config);

            playerInstance.on('error', function(event) {
                console.error('Error de JWPlayer:', event.message);
                document.getElementById("player").textContent = "Error: " + event.message;
            });
            playerInstance.on('ready', function() {
                 document.getElementById("player").textContent = "Reproductor Listo. Stream: " + selectedValue.nombre;
            });
             playerInstance.on('play', function() {
                 document.getElementById("player").textContent = "Reproduciendo: " + selectedValue.nombre;
            });
            playerInstance.on('pause', function() {
                 document.getElementById("player").textContent = "Pausado: " + selectedValue.nombre;
            });

        }

        function playPause() {
            if (playerInstance) {
                if (playerInstance.getState() === "playing") {
                    playerInstance.pause();
                } else {
                    playerInstance.play();
                }
            } else {
                console.warn("Player no inicializado.");
            }
        }

        function changeVolume(amount) {
            if (playerInstance) {
                var currentVolume = playerInstance.getVolume();
                var newVolume = Math.max(0, Math.min(100, currentVolume + amount));
                playerInstance.setVolume(newVolume);
            } else {
                console.warn("Player no inicializado.");
            }
        }

        function changeAudioTrack(offset) {
            if (playerInstance) {
                var audioTracks = playerInstance.getAudioTracks();
                if (audioTracks && audioTracks.length > 1) {
                    var currentAudioTrackIndex = playerInstance.getCurrentAudioTrack(); // Esto da el índice
                    var newTrackIndex = currentAudioTrackIndex + offset;
                    
                    if (newTrackIndex < 0) {
                        newTrackIndex = audioTracks.length - 1;
                    } else if (newTrackIndex >= audioTracks.length) {
                        newTrackIndex = 0;
                    }
                    playerInstance.setCurrentAudioTrack(newTrackIndex);
                } else {
                    console.log("No hay múltiples pistas de audio o no se pudieron obtener.");
                }
            } else {
                console.warn("Player no inicializado.");
            }
        }
    </script>
</body>
</html>