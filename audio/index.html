<!DOCTYPE html>
<html>
<head>
    <title>Reproductor de Audio de Streams</title>
    <script type='text/javascript' src="//ssl.p.jwpcdn.com/player/v/8.25.0/jwplayer.js"></script>
    <script type='text/javascript'>jwplayer.key='XSuP4qMl+9tK17QNb+4+th2Pm9AWgMO/cYH8CI0HGGr7bdjo'</script>
    <style>
        body {
            font-family: sans-serif;
            margin: 20px;
            background-color: #f4f4f4;
        }
        #player {
            width: 100%;
            height: 40px;
            background-color: #000;
            color: #fff;
            text-align: center;
            line-height: 40px;
            margin-bottom: 10px;
            box-sizing: border-box;
        }
        #controls {
            margin-top: 10px;
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        select {
            width: 100%;
            padding: 8px;
            margin-bottom: 15px;
            border-radius: 4px;
            border: 1px solid #ccc;
            box-sizing: border-box;
        }
        button {
            padding: 10px 15px;
            margin-right: 5px;
            border: none;
            border-radius: 4px;
            background-color: #007bff;
            color: white;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        .container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            max-width: 500px;
            margin: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <div>
            <label for="categorySelector">Selecciona una categoría:</label>
            <select id="categorySelector" onchange="updateChannelList()"></select>
        </div>
        <div>
            <label for="channelSelector">Selecciona un canal:</label>
            <select id="channelSelector" onchange="cargarStream()"></select>
        </div>
        <div id="player">CARGANDO REPRODUCTOR...</div>
        <div id="controls">
            <button onclick="playPause()">Play/Pausa</button>
            <button onclick="changeVolume(-10)">Bajar Volumen</button>
            <button onclick="changeVolume(10)">Subir Volumen</button>
            <button onclick="changeAudioTrack(-1)">Track Anterior</button>
            <button onclick="changeAudioTrack(1)">Siguiente Track</button>
        </div>
    </div>

    <script type='text/javascript'>
        var playerInstance = null;
        var canales = [];
        var categorias = [];

        fetch('canales.json')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok ' + response.statusText);
                }
                return response.json();
            })
            .then(data => {
                canales = data;
                categorias = obtenerCategoriasOrdenadas();
                cargarCategorias();
                if (categorias.length > 0) {
                    document.getElementById("categorySelector").value = categorias[0];
                    updateChannelList();
                }
            })
            .catch(error => {
                console.error('Error al cargar el JSON de canales:', error);
                document.getElementById("player").textContent = "Error al cargar lista de canales.";
            });

        function cargarCategorias() {
            var selectBox = document.getElementById("categorySelector");
            selectBox.innerHTML = "";
            if (categorias.length === 0) {
                var option = document.createElement("option");
                option.text = "No hay categorías disponibles";
                option.disabled = true;
                selectBox.add(option);
                return;
            }
            categorias.forEach(function(categoria) {
                var option = document.createElement("option");
                option.text = categoria;
                option.value = categoria;
                selectBox.add(option);
            });
        }

        function obtenerCategoriasOrdenadas() {
            var categoriasSet = new Set();
            canales.forEach(function(canal) {
                if (canal.url && canal.url.startsWith("http") && (canal.url.includes(".m3u8") || canal.url.includes(".mpd"))) {
                    categoriasSet.add(canal.categoria);
                }
            });
            return Array.from(categoriasSet).sort();
        }

        function updateChannelList() {
            var selectedCategory = document.getElementById("categorySelector").value;
            var channelSelector = document.getElementById("channelSelector");
            channelSelector.innerHTML = "";

            var filteredChannels = canales.filter(function(canal) {
                return canal.categoria === selectedCategory &&
                       canal.url &&
                       canal.url.startsWith("http") &&
                       (canal.url.includes(".m3u8") || canal.url.includes(".mpd"));
            });

            filteredChannels.sort(function(a, b) {
                return a.nombre.localeCompare(b.nombre);
            });

            if (filteredChannels.length === 0) {
                var option = document.createElement("option");
                option.text = "No hay canales disponibles en esta categoría";
                option.disabled = true;
                channelSelector.add(option);
                if(playerInstance) {
                    playerInstance.remove();
                    playerInstance = null;
                }
                document.getElementById("player").textContent = "Seleccione un canal";
                return;
            }

            filteredChannels.forEach(function(canal) {
                var option = document.createElement("option");
                option.text = canal.nombre;
                option.value = JSON.stringify(canal);
                channelSelector.add(option);
            });

            if (filteredChannels.length > 0) {
                cargarStream();
            }
        }

        function cargarStream() {
            var selectBox = document.getElementById("channelSelector");
            if (!selectBox.value || selectBox.selectedOptions.length === 0 || selectBox.selectedOptions[0].disabled) {
                if(playerInstance) {
                    playerInstance.remove();
                    playerInstance = null;
                }
                document.getElementById("player").textContent = "Seleccione un canal válido.";
                return;
            }
            var selectedValue;
            try {
                selectedValue = JSON.parse(selectBox.value);
            } catch (e) {
                document.getElementById("player").textContent = "Error en datos del canal.";
                return;
            }

            if (!selectedValue || !selectedValue.url || !selectedValue.url.startsWith("http")) {
                 if(playerInstance) {
                    playerInstance.stop();
                 }
                 document.getElementById("player").textContent = "URL de stream inválida.";
                 return;
            }
            
            document.getElementById("player").textContent = "CARGANDO STREAM: " + selectedValue.nombre;

            var streamType = selectedValue.url.includes(".mpd") ? "mpd" : "hls";

            var config = {
                playlist: [{
                    title: selectedValue.nombre || "Audio Stream",
                    sources: [{
                        file: selectedValue.url,
                        type: streamType
                    }]
                }],
                width: "100%",
                height: 40,
                autostart: true,
                audioOnly: true,
                visualPlaylist: false,
                controls: true 
            };
            
            if (selectedValue.keyId && selectedValue.key) {
                config.drm = {
                    clearkey: {
                        keyId: selectedValue.keyId,
                        key: selectedValue.key
                    }
                };
            }
            
            if (playerInstance) {
                playerInstance.remove();
            }
            playerInstance = jwplayer("player").setup(config);

            playerInstance.on('error', function(event) {
                document.getElementById("player").textContent = "Error: " + event.message + " (" + selectedValue.nombre + ")";
            });

            playerInstance.on('ready', function() {
                 document.getElementById("player").textContent = "Reproductor Listo. Stream: " + selectedValue.nombre;
                 if (playerInstance.getState() !== 'playing' && playerInstance.getState() !== 'buffering') {
                    playerInstance.play().catch(function(e) {
                        document.getElementById("player").textContent = "Play bloqueado. Haz clic en Play/Pausa.";
                    });
                 }
            });
             playerInstance.on('play', function(event) {
                 document.getElementById("player").textContent = "Reproduciendo: " + selectedValue.nombre;
            });
            playerInstance.on('pause', function() {
                 document.getElementById("player").textContent = "Pausado: " + selectedValue.nombre;
            });
            playerInstance.on('buffer', function() {
                document.getElementById("player").textContent = "Cargando buffer: " + selectedValue.nombre;
            });
             playerInstance.on('complete', function() {
                document.getElementById("player").textContent = "Stream completado: " + selectedValue.nombre;
            });
        }

        function playPause() {
            if (playerInstance) {
                if (playerInstance.getState() === "playing") {
                    playerInstance.pause();
                } else {
                    playerInstance.play();
                }
            }
        }

        function changeVolume(amount) {
            if (playerInstance) {
                var currentVolume = playerInstance.getVolume();
                var newVolume = Math.max(0, Math.min(100, currentVolume + amount));
                playerInstance.setVolume(newVolume);
            }
        }

        function changeAudioTrack(offset) {
            if (playerInstance) {
                var audioTracks = playerInstance.getAudioTracks();
                if (audioTracks && audioTracks.length > 1) {
                    var currentAudioTrackIndex = playerInstance.getCurrentAudioTrack();
                    var newTrackIndex = currentAudioTrackIndex + offset;
                    
                    if (newTrackIndex < 0) {
                        newTrackIndex = audioTracks.length - 1;
                    } else if (newTrackIndex >= audioTracks.length) {
                        newTrackIndex = 0;
                    }
                    playerInstance.setCurrentAudioTrack(newTrackIndex);
                }
            }
        }
    </script>
</body>
</html>