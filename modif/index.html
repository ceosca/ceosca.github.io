<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Series</title>
    <style>
        html,body{margin:0;padding:0;box-sizing:border-box}
        :root{--pc:#4CAF50;--pcd:#3e8e41;--tc:#333;--bc:#f4f4f4;--w:#fff;--s:0 0 5px rgba(0,0,0,.1);--fo:3px solid #007bff;--foo:2px}
        body{font-family:Arial,sans-serif;background-color:var(--bc);font-size:1.2em;line-height:1.6;color:var(--tc)}
        h2{font-size:1.8em;margin-bottom:.5em}
        .c{width:95%;margin:10px auto;background-color:var(--w);padding:15px;box-shadow:var(--s)}
        .b{padding:12px 18px;border:none;cursor:pointer;border-radius:5px;transition:background-color .2s ease,box-shadow .2s ease;font-size:1em;background-color:var(--pc);color:var(--w);margin-top:5px}
        .b:hover,.b:focus{box-shadow:var(--s);outline:none}
        .bp:hover,.bp:focus{background-color:var(--pcd)}
        .sl{list-style-type:none;padding:0}
        .sl li{margin-bottom:10px}
        .sl button{width:100%;text-align:left;font-size:1.1em;display:block}
        .view-hidden{display:none !important}
        #player-view{padding-top:80px;padding-bottom:180px;position:relative}
        .fh{position:fixed;top:0;left:0;width:100%;background-color:var(--w);padding:10px 20px;z-index:2;box-shadow:0 2px 5px rgba(0,0,0,.2);display:flex;justify-content:space-between;align-items:center}
        .fp{position:fixed;bottom:0;left:0;width:100%;background-color:#f0f0f0;padding:10px;text-align:center;z-index:2;box-shadow:0 -2px 5px rgba(0,0,0,.2);display:flex;justify-content:space-around;align-items:center;flex-wrap:wrap}
        .fp button,.fp select{background-color:#555;color:var(--w);transition:background-color .3s;font-size:.9em;padding:8px 12px;margin-bottom:5px;border:none;border-radius:5px;cursor:pointer}
        .fp button:hover,.fp select:hover{background-color:#777}
        .fp #ti,.fp #ci{font-size:.8em;color:var(--tc);width:100%;text-align:center;order:-1}
        .lc,.ec,.tc{margin-top:1em;width:100%}
        .tc{margin-bottom:1em}
        .lc label,.ec label,.tc label{display:block;margin-bottom:.5em;font-size:1.1em}
        .lc select,.ec select,.tc select{width:100%;padding:10px;font-size:1em;border:1px solid #ccc;border-radius:5px;margin-bottom:1em;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 10px top 50%;background-size:1.5em}
        .h{display:none !important}
        *:focus{outline:var(--fo);outline-offset:var(--foo)}
        #search-container{margin-bottom:20px}
        #search-input{width:100%;padding:10px;font-size:1em;border:1px solid #ccc;border-radius:5px}
        @media (max-width:600px){
            body{font-size:1.1em}
            h2{font-size:1.5em}
            .c{padding:10px}
            .sl button{padding:12px 15px;font-size:1em}
        }
        #as{margin-bottom:20px;padding-bottom:15px;border-bottom:1px solid #eee;text-align:center}
        #as p{margin-bottom:10px}
        #cw{margin-bottom:20px}
        #cw h2{font-size:1.5em;margin-bottom:10px}
        #cw ul{list-style:none;padding:0}
        #cw li{margin-bottom:5px}
        #cw li button{margin-right:5px}
        #usac{margin-bottom:20px}
        #usac h2{font-size:1.5em;margin-bottom:10px}
        #t10smv-c{margin-bottom:20px} 
        #t10smv-c h2{font-size:1.5em;margin-bottom:10px} 
        #selector-series{text-align:center;margin-bottom:20px}
        #selector-series h2{margin-bottom:10px}
        #selector-series ul{list-style:none;padding:0;display:flex;justify-content:center;flex-wrap:wrap}
        #selector-series li{margin:5px 10px}
        #selector-series a{text-decoration:none;color:var(--pc);font-weight:bold;padding:8px 12px;border:2px solid var(--pc);border-radius:5px;transition:background-color .2s ease,color .2s ease;display:block}
        #selector-series a:hover{background-color:var(--pc);color:var(--w)}
        #acc-info{position:absolute;left:-10000px;top:auto;width:1px;height:1px;overflow:hidden}
    </style>
</head>
<body>
    <div id="list-view">
        <div class="c">
            <div id="as">
                <p>¡te doy la bienvenida! Puedes explorar y escuchar series sin iniciar sesión. Si deseas guardar tu progreso y continuar escuchando más tarde donde lo dejaste, </p>
                <button id="gsi" class="b">Inicia sesión con Google</button>
                <button id="so" class="b h">Cerrar sesión</button>
            </div>
            <div id="selector-series">
                <h2>¿Qué quieres escuchar?</h2>
                <ul>
                    <li><a href="#" id="en-espanol">Series en español original</a></li>
                    <li><a href="#" id="con-doblaje">Series con doblaje</a></li>
                </ul>
            </div>
            <div id="search-container">
                <input type="search" id="search-input" placeholder="Buscar series por nombre...">
            </div>
            <div id="mc">
                <main>
                    <div id="cw" class="h">
                        <h2>Continuar escuchando</h2>
                        <ul id="cwl"></ul>
                    </div>
                    <div id="usac">
                        <h2>Últimas Series Agregadas</h2>
                        <ul id="usal" class="sl"></ul> 
                    </div>
                    <div id="t10smv-c"> 
                        <h2>Las 10 series más escuchadas</h2>
                        <ul id="t10l" class="sl"></ul> 
                    </div>
                    <div id="coc"></div>
                </main>
            </div>
        </div>
    </div>

    <div id="player-view" class="view-hidden">
        <header class="fh">
            <h2 id="modal-title">Detalles de la Serie</h2>
            <button class="close b bp" id="cb" aria-label="Regresar">Regresar</button>
        </header>
        <main class="c">
            <div id="si" aria-live="polite"></div>
            <section class="tc h" id="tasc">
                <label for="t">Temporada:</label>
                <select id="t"></select>
            </section>
            <audio id="ap">Audio no soportado.</audio>
            <h2>Reproductor</h2>
        </main>
        <footer class="fp">
            <div id="ci"></div>
            <div id="ti"></div>
            <button id="ppb" class="b" aria-label="Reproducir/Pausar (Alt + K)">Reproducir</button>
            <button id="fb" class="b" aria-label="Avanzar 15 segundos (Alt + L)">Avanzar</button>
            <button id="bb" class="b" aria-label="Retroceder 15 segundos (Alt + J)">Retroceder</button>
            <button id="reb" class="b" aria-label="Reiniciar episodio (Alt + R)">Reiniciar episodio</button>
            <button id="ncb" class="b" aria-label="Siguiente episodio (Alt + S)">Siguiente episodio</button>
            <button id="pcb" class="b" aria-label="Episodio anterior (Alt + A)">Episodio anterior</button>
            <button id="ivb" class="b" aria-label="Subir volumen (Alt + O)">Subir volumen</button>
            <button id="dvb" class="b" aria-label="Bajar volumen (Alt + U)">Bajar volumen</button>
            <select id="speed-selector" aria-label="Control de velocidad">
                <option value="0.75">0.75x</option>
                <option value="1" selected>Normal</option>
                <option value="1.25">1.25x</option>
                <option value="1.5">1.5x</option>
                <option value="2">2x</option>
            </select>
            <section class="ec" id="easc">
                <label for="c">Capítulo:</label>
                <select id="c"></select>
            </section>
            <section class="lc h" id="lasc">
                <label for="l">Pista de audio:</label>
                <select id="l"></select>
            </section>
        </footer>
    </div>
    <div id="acc-info" aria-live="polite"></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-app.js";
    import { getFirestore, collection, doc, setDoc, getDoc, query, where, getDocs, serverTimestamp, deleteDoc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-firestore.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-auth.js";

    const fC={apiKey:"AIzaSyAGzPA5b5P1NofFZtbBvGpuYE3tVR-JaS0",authDomain:"pfdsuaaug.firebaseapp.com",projectId:"pfdsuaaug",storageBucket:"pfdsuaaug.firebasestorage.app",messagingSenderId:"701797222900",appId:"1:701797222900:web:01836d45db1b35be2bd1a1"},app=initializeApp(fC),db=getFirestore(app),auth=getAuth(app),gP=new GoogleAuthProvider,gSI=document.getElementById('gsi'),sO=document.getElementById('so'),EEL=document.getElementById('en-espanol'),CDL=document.getElementById('con-doblaje'),SDP1='https://ceosca.github.io/',SDP2='series/series.json',SDP3='series/doblaje.json',A=document.getElementById('ap'),MC_DIV=document.getElementById('mc'),CBC=document.getElementById("cb"),PB=document.getElementById('ppb'),CS=document.getElementById('c'),LC=document.getElementById('lasc'),LS=document.getElementById('l'),CI=document.getElementById('ci'),TI=document.getElementById('ti'),CWL=document.getElementById('cwl'),TS=document.getElementById('t'),SEL_SER_DIV=document.getElementById('selector-series'),USAL=document.getElementById('usal'),REB=document.getElementById('reb'),T10L=document.getElementById('t10l'),ESD="estadisticasSeries",CVD="conteoVistasGlobal",ACCI=document.getElementById('acc-info'),listView=document.getElementById('list-view'),playerView=document.getElementById('player-view'),sI=document.getElementById('search-input'),pS=document.getElementById('speed-selector');
    let TII,IP=!1,CSD_L=[],CLI=0,CCL=0,CPT=0,S,SD_J=SDP1+SDP2,TS_C=[],isUCWRunning=!1,isCSRSRunning=!1,isManuallySwitchingChapter=!1,lastFocusedElement=null,eC=!1;const UMBRAL_ESCUCHA=60;
    const GNB=t=>t.split(', temporada')[0].trim(),slugify=t=>t.toString().normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim().replace(/\s+/g,'-').replace(/[^\w-]+/g,'').replace(/--+/g,'-'),nmlz=t=>slugify(t).replace(/-/g,' ');
    const MCGLTSL=(n,c,s)=>{const l=s.filter(t=>GNB(t.nombre)===n),o=OTS(l);let g=0;for(const p of o){const h=p.capitulos.length;if(c<g+h)return{stp:p,ccl:c-g};g+=h}return o.length>0?{stp:o[0],ccl:0}:{stp:null,ccl:0}};
    const MTSLCG=(t,c,s)=>{const n=GNB(t.nombre),l=s.filter(t=>GNB(t.nombre)===n),o=OTS(l);let g=0;for(const p of o){if(p.nombre===t.nombre){g+=c;return g}if(p.capitulos)g+=p.capitulos.length}return c};
    const sWGi=async()=>{try{await signInWithPopup(auth,gP)}catch(t){}},sOG=async()=>{try{await signOut(auth)}catch(t){}};onAuthStateChanged(auth,t=>{const c=document.querySelector('#as p');t?(gSI.classList.add('h'),sO.classList.remove('h'),c&&(c.textContent="¡Hola de nuevo! Tu progreso se guardará automáticamente.")):(gSI.classList.remove('h'),sO.classList.add('h'),c&&(c.textContent="¡Bienvenido/a! Puedes explorar y escuchar series sin iniciar sesión. Si deseas guardar tu progreso y continuar escuchando más tarde donde lo dejaste, por favor:")),UCW()});gSI.addEventListener('click',sWGi),sO.addEventListener('click',sOG);
    const FT=t=>{const c=Math.floor(t/60),s=Math.floor(t%60);return`${PZ(c)}:${PZ(s)}`},PZ=t=>("0"+t).slice(-2);
    const GP=async()=>{if(!S||!auth.currentUser)return;const t=A.currentTime,c=GNB(S.nombre),s=MTSLCG(S,CCL,TS_C);try{const n=auth.currentUser,l={serieNombreBase:c,capituloGlobalIndex:s,tiempo:t,idiomaIndex:CLI,serieTemporadaActualNombre:S.nombre,userId:n.uid,ultimaActualizacion:serverTimestamp()};await setDoc(doc(db,"progresoSeries",`${n.uid}_${c}`),l),UCW()}catch(t){}},RP=async t=>{if(!auth.currentUser||!TS_C||0===TS_C.length)return!1;try{const c=auth.currentUser,s=await getDoc(doc(db,"progresoSeries",`${c.uid}_${t}`));if(s.exists()){const n=s.data(),{stp:l,ccl:o}=MCGLTSL(t,n.capituloGlobalIndex,TS_C);if(l)return S=l,CCL=o,A.currentTime=n.tiempo,CLI=n.idiomaIndex||0,document.getElementById('tasc').classList.contains('h')===!1&&TS.options.length>0&&(TS.value=S.nombre),CS.value=CCL,LS.value=CLI,UC(),!0}}catch(t){}return!1};
    const showListView=()=>{S&&GP(),playerView.classList.add('view-hidden'),listView.classList.remove('view-hidden'),listView.removeAttribute('inert'),A.pause(),A.src='',clearInterval(TII),IP=!1,PB.textContent='Reproducir',CPT=A.currentTime,CI.textContent='',TI.textContent='',ACCI&&""===(ACCI.textContent=""),isManuallySwitchingChapter=!1,window.scrollTo(0,0),lastFocusedElement&&lastFocusedElement.focus()},showPlayerView=(t,c=null)=>{c&&(lastFocusedElement=c);const s=GNB(t.nombre);IP=!1,CLI=0,CCL=0,CPT=0,CSD_L=[];(async()=>{TS_C.length||(TS_C=await FD());const c=await RP(s);c?CPT=A.currentTime:(S=t,CCL=0,CLI=0,S&&S.capitulos&&S.capitulos[CCL]?CPT=S.capitulos[CCL].inicio/1e3:CPT=0,document.getElementById('tasc').classList.contains('h')===!1&&TS.options.length>0&&Array.from(TS.options).some(t=>t.value===S.nombre)&&(TS.value=S.nombre)),LI(S),LL(S),LCF(S),A.play().catch(t=>{}),IP=!0,PB.textContent='Pausar',PB.setAttribute('aria-label','Pausar (Alt + K)'),UC()})(),listView.classList.add('view-hidden'),listView.setAttribute('inert',''),playerView.classList.remove('view-hidden');const n=new URL(window.location);n.searchParams.set('serie',slugify(GNB(t.nombre))),history.pushState({view:'player',serie:slugify(GNB(t.nombre))},'',n),CBC.focus(),window.scrollTo(0,0)};
    const rVU=async()=>{if(!S||!auth.currentUser)return;const t=GNB(S.nombre),c=auth.currentUser,s=(new Date).toISOString().split("T")[0],n=`${c.uid}_${t}_${s}`;try{const c=doc(db,"vistasDiarias",n),l=await getDoc(c);if(!l.exists()){await setDoc(c,{timestamp:serverTimestamp()});const c=doc(db,ESD,CVD),s=`vistasPorSerie.${t.replace(/\./g,"_")}`;await updateDoc(c,{[s]:increment(1)})}}catch(t){}};
    const lS=()=>{try{const t=localStorage.getItem('pS');if(t){const c=JSON.parse(t);A.volume=c.v||1,pS.value=c.s||1,A.playbackRate=c.s||1}}catch(t){A.volume=1,pS.value=1,A.playbackRate=1}},sS=()=>{try{const t={v:A.volume,s:A.playbackRate};localStorage.setItem('pS',JSON.stringify(t))}catch(t){}};
    const LCF=(t,c=!1)=>{eC=!1,CS.innerHTML='',CSD_L=t.capitulos,CSD_L.forEach((t,c)=>{const s=document.createElement('option');s.value=c,s.textContent=t.titulo,CS.appendChild(s)}),CS.value=CCL,UC(),A.src=t.enlaces[CLI].enlace;const s=CPT,n=()=>{A.currentTime=s,c&&A.play().catch(t=>{})};A.onloadedmetadata=null,A.addEventListener('canplay',n,{once:!0}),lS(),A.load(),clearInterval(TII),UT(),TII=setInterval(UT,1e3)};
    const FD=async()=>{try{const t=await fetch(SD_J);if(!t.ok)throw new Error(`E!S:${t.status}`);const c=await t.json();return c.series||[]}catch(t){return[]}},OTS=t=>[...t].sort((t,c)=>{const s=t=>{const c=t.split(", temporada ");if(c.length>1){const t=parseInt(c[1]);return isNaN(t)?1/0:t}return 1},n=s(t.nombre),l=s(c.nombre);return n!==l?n-l:t.nombre.localeCompare(c.nombre)}),RCAS=t=>{const c=document.getElementById('coc');if(c.innerHTML="",!t||0===t.length)return void(c.innerHTML="<p>No hay series.</p>");const s={};t.forEach(t=>{const c=GNB(t.nombre);s[c]||(s[c]=[]),s[c].push(t)});const n=[...new Set(t.map(t=>t.pais_origen))].sort();n.forEach(t=>{const n=document.createElement('h2');n.textContent=t,c.appendChild(n);const l=document.createElement('ul');l.classList.add('sl'),Object.keys(s).sort((t,c)=>t.localeCompare(c,'es',{sensitivity:'base'})).forEach(t=>{const c=s[t].filter(c=>c.pais_origen===t);if(c.length>0){const s=document.createElement('li'),n=document.createElement('button');n.textContent=t,n.addEventListener('click',s=>{const n=OTS(c),o=n[0];showPlayerView(o,s.currentTarget),n.length>1?LT(n,o.nombre):document.getElementById('tasc').classList.add('h')}),n.setAttribute('tabindex','0'),n.classList.add('b'),s.appendChild(n),l.appendChild(s)}}),c.appendChild(l)}),UCW()},LUSA=t=>{if(!USAL||!t||0===t.length)return void(USAL&&(USAL.innerHTML="<li>No hay series nuevas.</li>"));USAL.innerHTML='';const c=t.slice(-20).reverse();c.forEach(t=>{const c=document.createElement('li'),s=document.createElement('button');s.textContent=t.nombre,s.classList.add('b'),s.addEventListener('click',c=>{const n=GNB(t.nombre),l=TS_C.filter(c=>GNB(c.nombre)===n);showPlayerView(t,c.currentTarget),l.length>1?(LT(OTS(l),t.nombre),void 0):document.getElementById('tasc').classList.add('h')}),c.appendChild(s),USAL.appendChild(c)})},CT10SMV=async()=>{if(!T10L)return;T10L.innerHTML='<li>Cargando...</li>';try{const t=doc(db,ESD,CVD),c=await getDoc(t);if(!c.exists()||!c.data().vistasPorSerie)return void(T10L.innerHTML="<li>Aún no hay datos.</li>");const s=c.data().vistasPorSerie,n=Object.entries(s).map(([t,c])=>({n:t.replace(/_/g,'.'),v:c})).sort((t,c)=>c.v-t.v).slice(0,10);if(0===n.length)return void(T10L.innerHTML="<li>No hay series en el top.</li>");if(T10L.innerHTML='',!TS_C||0===TS_C.length)return void(T10L.innerHTML="<li>Error: datos de series no disponibles para el Top 10.</li>");n.forEach(t=>{const c=TS_C.filter(c=>GNB(c.nombre)===t.n);if(c.length>0){c[0];const s=document.createElement('li'),n=document.createElement('button');n.textContent=`${t.n} (${t.v} ${1===t.v?"escucha":"escuchas"})`,n.classList.add('b'),n.addEventListener('click',c=>{const s=TS_C.filter(c=>GNB(c.nombre)===t.n),l=OTS(s);l.length>0&&(showPlayerView(l[0],c.currentTarget),l.length>1?LT(l,l[0].nombre):document.getElementById('tasc').classList.add('h'))}),s.appendChild(n),T10L.appendChild(s)}}),0===T10L.children.length&&n.length>0&&(T10L.innerHTML="<li>No se pudieron mostrar (datos no encontrados).</li>"),0===T10L.children.length&&0===n.length&&(T10L.innerHTML="<li>No hay series en el top.</li>")}catch(t){T10L.innerHTML="<li>Error al cargar.</li>"}},LT=(t,c)=>{TS.innerHTML='',document.getElementById('tasc').classList.remove('h'),t.forEach(t=>{const c=t.nombre.split(', temporada ')[1],s=document.createElement('option');s.value=t.nombre,s.textContent=c?`Temporada ${c}`:t.nombre,TS.appendChild(s)}),c&&(TS.value=c),TS.onchange=t=>{const c=t.target.value,s=TS_C.find(t=>t.nombre===c);s&&(S=s,CCL=0,CPT=0,A.currentTime=0,CLI=parseInt(LS.value)||0,LI(S),LL(S),LCF(S),A.play().catch(t=>{}),IP=!0,PB.textContent='Pausar',PB.setAttribute('aria-label','Pausar (Alt + K)'))}},LI=t=>{const c=document.getElementById('si');let s="";SD_J===SDP1+SDP2&&t.reparto&&(s=`<div><strong>Reparto:</strong> ${t.reparto.join(", ")}</div>`),S=t,c.innerHTML=`<h2>${t.nombre}</h2><div><strong>Género:</strong> ${t.genero}</div><div><strong>Año:</strong> ${t.anio}</div>${s}<div><strong>País:</strong> ${t.pais_origen}</div><div><strong>Episodios:</strong> ${t.cantidad_episodios}</div>${t.sinopsis?`<div><strong>Sinopsis:</strong> ${t.sinopsis}</div>`:""}`},LL=t=>{LS.innerHTML='',t.enlaces.length>1?(t.enlaces.forEach((t,c)=>{const s=document.createElement('option');s.value=c,s.textContent=t.idioma,LS.appendChild(s)}),LC.classList.remove('h')):LC.classList.add('h'),LS.value=CLI},UC=()=>{CI.textContent=CSD_L&&CSD_L[CCL]&&CSD_L[CCL].titulo?IP?`Reproduciendo: ${CSD_L[CCL].titulo}`:`${CSD_L[CCL].titulo}`:"Cargando..."},UT=()=>{if(!eC&&A.currentTime>UMBRAL_ESCUCHA&&(rVU(),eC=!0),!CSD_L||0===CSD_L.length)return;const t=A.currentTime,c=GCI(t);if(!(c<0||c>=CSD_L.length||!CSD_L[c])){const s=CSD_L[c];if(s&&"undefined"!=typeof s.inicio&&"undefined"!=typeof s.fin){const c=s.inicio/1e3,n=s.fin/1e3;isNaN(c)||isNaN(n)||isNaN(t)||(TI.textContent=`${FT(t-c)} / ${FT(n-c)}`)}if(CSD_L[CCL]&&CSD_L[CCL].titulo&&(CI.textContent=IP?`Reproduciendo: ${CSD_L[CCL].titulo}`:`${CSD_L[CCL].titulo}`),isManuallySwitchingChapter)return void(c===parseInt(CS.value)&&(isManuallySwitchingChapter=!1,CCL!==c&&(CCL=c,UC())));c!==CCL&&parseInt(CS.value)!==c?(CCL=c,CS.value=CCL,UC(),ACCI&&CSD_L[CCL]&&CSD_L[CCL].titulo&&(ACCI.textContent=CSD_L[CCL].titulo)):c!==CCL&&parseInt(CS.value)===c&&(CCL=c,UC())}},TP=()=>{IP?(A.pause(),IP=!1,PB.textContent='Reproducir',PB.setAttribute('aria-label','Reproducir (Alt + K)')):(A.play().catch(t=>{}),IP=!0,PB.textContent='Pausar',PB.setAttribute('aria-label','Pausar (Alt + K)'),UC())},F=()=>{A.currentTime+=15},B=()=>{if(S&&CSD_L&&"undefined"!=typeof CCL&&CSD_L[CCL]){const t=CSD_L[CCL].inicio/1e3,c=A.currentTime-15;A.currentTime=c<t?t:c}else A.currentTime-=15},RE=()=>{S&&CSD_L&&"undefined"!=typeof CCL&&CSD_L[CCL]&&(isManuallySwitchingChapter=!0,A.currentTime=CSD_L[CCL].inicio/1e3,IP||(A.play().catch(t=>{}),IP=!0,PB.textContent='Pausar',PB.setAttribute('aria-label','Pausar (Alt + K)')),UC(),PC(!0,!0))},PC=(t=!1,c=!1)=>{CCL=parseInt(CS.value),CSD_L&&CSD_L[CCL]&&(A.currentTime=CSD_L[CCL].inicio/1e3,A.play().catch(t=>{}),IP=!0,PB.textContent='Pausar',PB.setAttribute('aria-label','Pausar (Alt + K)'),UC(),ACCI&&(t&&!c&&CSD_L[CCL].titulo?ACCI.textContent=CSD_L[CCL].titulo:c&&(ACCI.textContent="")))},GCI=t=>{let c=0;if(!CSD_L||0===CSD_L.length)return 0;for(let s=0;s<CSD_L.length;s++){const n=CSD_L[s];if(n&&"undefined"!=typeof n.inicio&&"undefined"!=typeof n.fin){if(t>=n.inicio/1e3&&t<=n.fin/1e3){c=s;break}if(t<n.inicio/1e3){c=s>0?s-1:0;break}if(s===CSD_L.length-1&&t>n.fin/1e3){c=s;break}}}return c},PP=()=>{let t=CCL;t>0&&(t--,CS.value=t,isManuallySwitchingChapter=!0,PC(!0,!0))},NP=()=>{let t=CCL;if(t<CSD_L.length-1)t++,CS.value=t,isManuallySwitchingChapter=!0,PC(!0,!0);else if(t===CSD_L.length-1){const t=GNB(S.nombre),c=TS_C.filter(c=>GNB(c.nombre)===t),s=OTS(c),n=s.findIndex(t=>t.nombre===S.nombre);n>=0&&n<s.length-1&&(isManuallySwitchingChapter=!0,showPlayerView(s[n+1]))}},CLS=()=>{const t=IP;CPT=A.currentTime,CLI=parseInt(LS.value),S&&(isManuallySwitchingChapter=!0,LCF(S,t))},IV=()=>{A.volume=Math.min(1,A.volume+.05),sS()},DV=()=>{A.volume=Math.max(0,A.volume-.05),sS()},DCW=async t=>{if(!auth.currentUser)return;try{const c=auth.currentUser;await deleteDoc(doc(db,"progresoSeries",`${c.uid}_${t}`)),UCW()}catch(t){}};
    const UCW=async()=>{if(isUCWRunning)return;isUCWRunning=!0,CWL.innerHTML='',auth.currentUser?(document.getElementById('cw').classList.remove('h'),(async()=>{try{const t=auth.currentUser,c=query(collection(db,"progresoSeries"),where("userId","==",t.uid),where("tiempo",">",10)),s=await getDocs(c),n=[];if(s.forEach(t=>{n.push({...t.data(),id:t.id})}),0===n.length)return void(CWL.innerHTML="<li>No tienes series para continuar.</li>");if(0===TS_C.length)return void(CWL.innerHTML="<li>Cargando lista de series para mostrar progreso...</li>");const l=TS_C;let o=0;for(const t of n){const{stp:c,ccl:s}=MCGLTSL(t.serieNombreBase,t.capituloGlobalIndex,l);if(c&&c.capitulos&&c.capitulos[s]){const n=c.capitulos[s],l=n.fin/1e3,a=FT(l-t.tiempo),i=document.createElement('li'),d=document.createElement('button');let r=c.nombre.includes(", temporada ")?`, temporada ${c.nombre.split(", temporada ")[1]}`:t.serieNombreBase!==c.nombre?`, ${c.nombre}`:"";d.textContent=`${t.serieNombreBase}${r}, ${n.titulo}, Restante: ${a}`,d.addEventListener('click',t=>{showPlayerView(c,t.currentTarget)}),d.classList.add('b'),i.appendChild(d);const u=document.createElement('button');u.textContent='Eliminar',u.classList.add('b'),u.style.backgroundColor='#f44336',u.addEventListener('click',c=>{c.stopPropagation(),DCW(t.serieNombreBase)}),i.appendChild(u),CWL.appendChild(i),o++}}0===o&&n.length>0&&(CWL.innerHTML="<li>No hay progreso para las series actualmente seleccionadas.</li>"),0===o&&0===n.length&&(CWL.innerHTML="<li>No tienes series para continuar.</li>")}catch(t){CWL.innerHTML="<li>Error al cargar progreso.</li>"}finally{isUCWRunning=!1}})()):(document.getElementById('cw').classList.add('h'),isUCWRunning=!1)};
    CBC.addEventListener('click',()=>{history.back()}),CS.addEventListener('change',()=>{S&&GP(),isManuallySwitchingChapter=!0,PC(!0,!0)}),A.addEventListener('play',()=>{IP=!0,PB.textContent='Pausar',PB.setAttribute('aria-label','Pausar (Alt + K)'),UC()}),A.addEventListener('pause',()=>{IP=!1,PB.textContent='Reproducir',PB.setAttribute('aria-label','Reproducir (Alt + K)'),S&&!playerView.classList.contains('view-hidden')&&GP()}),A.addEventListener('ended',()=>{NP()}),LS.addEventListener('change',CLS),PB.addEventListener('click',TP),document.getElementById('fb').addEventListener('click',F),document.getElementById('bb').addEventListener('click',B),REB.addEventListener('click',RE),document.getElementById('pcb').addEventListener('click',PP),document.getElementById('ncb').addEventListener('click',NP),document.getElementById('ivb').addEventListener('click',IV),document.getElementById('dvb').addEventListener('click',DV),pS.addEventListener('change',t=>{A.playbackRate=parseFloat(t.target.value),sS()});
    const CSRS=async()=>{if(isCSRSRunning)return;isCSRSRunning=!0;try{const t=await FD();if(TS_C=t,RCAS(t),t&&t.length>0&&LUSA(t),await CT10SMV(),await UCW(),new URLSearchParams(window.location.search).get('serie')){const c=new URLSearchParams(window.location.search).get('serie'),s=TS_C.find(t=>slugify(GNB(t.nombre))===c);if(s){showPlayerView(s);const t=OTS(TS_C.filter(t=>GNB(t.nombre)===GNB(s.nombre)));t.length>1&&LT(t,s.nombre)}}}catch(t){}finally{isCSRSRunning=!1}};
    const hS=()=>{const t=nmlz(sI.value);document.querySelectorAll('#cwl, #usal, #t10l, #coc').forEach(c=>{let s=!1;c.querySelectorAll('li').forEach(c=>{const n=c.querySelector('button'),l=n?nmlz(n.textContent):"";l.includes(t)?(c.style.display="",s=!0):c.style.display="none"});const n=c.previousElementSibling;n&&"H2"===n.tagName&&(n.style.display=s?"":"none")})};sI.addEventListener('input',hS);
    EEL.addEventListener('click',t=>{t.preventDefault(),SD_J===SDP1+SDP2&&TS_C.length>0||(SD_J=SDP1+SDP2,CSRS())}),CDL.addEventListener('click',t=>{t.preventDefault(),SD_J===SDP1+SDP3&&TS_C.length>0||(SD_J=SDP1+SDP3,CSRS())}),window.addEventListener('popstate',t=>{t.state&&"list"!==t.state.view||showListView()}),window.onload=()=>{history.replaceState({view:'list'},'',''),CSRS()},setInterval(()=>{!playerView.classList.contains('view-hidden')&&S&&IP&&GP()},1e4),document.addEventListener('keydown',function(t){const c=!playerView.classList.contains('view-hidden');if(t.altKey&&c){if("ArrowLeft"===t.key)return t.preventDefault(),void history.back();const s=t.key.toLowerCase();let n=!1;switch(s){case"k":PB&&PB.click()&&(n=!0);break;case"j":{const c=document.getElementById('bb');c&&(c.click(),TI&&ACCI&&(UT(),ACCI.textContent=TI.textContent),n=!0)}break;case"l":{const c=document.getElementById('fb');c&&(c.click(),TI&&ACCI&&(UT(),ACCI.textContent=TI.textContent),n=!0)}break;case"u":{const c=document.getElementById('dvb');c&&c.click()&&(n=!0)}break;case"o":{const c=document.getElementById('ivb');c&&c.click()&&(n=!0)}break;case"r":REB&&REB.click()&&(n=!0);break;case"a":{const c=document.getElementById('pcb');c&&c.click()&&(n=!0)}break;case"s":{const c=document.getElementById('ncb');c&&c.click()&&(n=!0)}break;case"i":S&&CSD_L&&"undefined"!=typeof CCL&&CSD_L[CCL]&&TI&&ACCI&&(UT(),(()=>{const t=GNB(S.nombre);let c=t;const n=S.nombre.split(", temporada ");n.length>1&&(c+=`. Temporada ${n[1]}`),c+=".";const l=CSD_L[CCL].titulo;ACCI.textContent=`${c} ${l}. ${TI.textContent}.`})(),n=!0);break;case"t":{const t=TS,c=document.getElementById('tasc');t&&c&&!c.classList.contains('h')&&(t.focus(),n=!0)}break;case"c":{const t=CS,c=document.getElementById('easc');t&&c&&!c.classList.contains('h')&&(t.focus(),n=!0)}break;case"p":{const t=LS,c=document.getElementById('lasc');t&&c&&!c.classList.contains('h')&&(t.focus(),n=!0)}break}n&&t.preventDefault()}});
</script> 
</body>
</html>