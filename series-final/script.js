import{initializeApp}from"https://www.gstatic.com/firebasejs/11.5.0/firebase-app.js";import{getFirestore,collection,doc,setDoc,getDoc,query,where,getDocs,serverTimestamp,deleteDoc}from"https://www.gstatic.com/firebasejs/11.5.0/firebase-firestore.js";import{getAuth,signInWithPopup,GoogleAuthProvider,signOut,onAuthStateChanged}from"https://www.gstatic.com/firebasejs/11.5.0/firebase-auth.js";const fC={apiKey:"AIzaSyAGzPA5b5P1NofFZtbBvGpuYE3tVR-JaS0",authDomain:"pfdsuaaug.firebaseapp.com",projectId:"pfdsuaaug",storageBucket:"pfdsuaaug.firebasestorage.app",messagingSenderId:"701797222900",appId:"1:701797222900:web:01836d45db1b35be2bd1a1"},app=initializeApp(fC),db=getFirestore(app),auth=getAuth(app),gP=new GoogleAuthProvider,gSI=document.getElementById('gsi'),sO=document.getElementById('so'),lE=(e,m="Error")=>console.error(`${m}:`,e),sWGi=async()=>{try{const r=await signInWithPopup(auth,gP),u=r.user;console.log("Usuario conectado con Google:",u.uid,u.displayName,u.email)}catch(e){lE(e,"Error al iniciar sesión con Google")}},sOG=async()=>{try{await signOut(auth);console.log("Usuario desconectado.")}catch(e){lE(e,"Error al cerrar sesión")}},uAu=()=>{gSI.classList.add('h'),sO.classList.remove('h'),uCW()},uAd=()=>{gSI.classList.remove('h'),sO.classList.add('h'),uCW()};onAuthStateChanged(auth,u=>{u?(console.log("Usuario conectado:",u.uid),uAu()):(console.log("Usuario desconectado"),uAd())}),gSI.addEventListener('click',sWGi),sO.addEventListener('click',sOG);const SDP1='https://ceosca.github.io/',SDP2='series/series.json',SD=SDP1+SDP2,A=document.getElementById('ap'),MC=document.getElementById('mc'),M=document.getElementById("sM"),CBC=document.getElementById("cb"),PB=document.getElementById('ppb'),CS=document.getElementById('c'),LC=document.getElementById('lasc'),LS=document.getElementById('l'),CI=document.getElementById('ci'),TI=document.getElementById('ti'),CWL=document.getElementById('cwl'),TS=document.getElementById('t'),cBtn=(t,cb,cn='b')=>{const b=document.createElement('button');return b.textContent=t,b.addEventListener('click',cb),b.classList.add(cn),b},cLWI=(bt,bc,dc,sn)=>{const li=document.createElement('li'),b=cBtn(bt,bc);li.appendChild(b);if(dc){const db=cBtn('Eliminar',()=>dc(sn));li.appendChild(db)}return li},V=(el,btn,s,h)=>(el.classList.contains('h')?(el.classList.remove('h'),btn.textContent=h):(el.classList.add('h'),btn.textContent=s)),FT=t=>{const m=Math.floor(t/60),s=Math.floor(t%60);return`${PZ(m)}:${PZ(s)}`},PZ=n=>(n<10?'0':'')+n,GP=async n=>{if(!S)return;const t=A.currentTime;try{const u=auth.currentUser;if(!u)throw new Error("No hay usuario conectado.");const p={serieNombre:S.nombre,capituloIndex:CCI,tiempo:t,idiomaIndex:CLI,userId:u.uid,ultimaActualizacion:serverTimestamp()};await setDoc(doc(db,"progresoSeries",`${u.uid}_${S.nombre}`),p);console.log("Progreso guardado en Firebase:",p);uCW()}catch(e){lE(e,"Error al guardar el progreso en Firebase")}},RP=async n=>{try{const u=auth.currentUser;if(!u)throw new Error("No hay usuario conectado.");const dS=await getDoc(doc(db,"progresoSeries",`${u.uid}_${n}`));if(dS.exists()){const d=dS.data();CCI=d.capituloIndex;A.currentTime=d.tiempo;CLI=d.idiomaIndex||0;CS.value=CCI;LS.value=CLI;uC();return!0}else{console.log("No se encontró el documento en Firebase.");return!1}}catch(e){lE(e,"Error al cargar el progreso de Firebase");return!1}},C=()=>{S&&GP(S.nombre),M.style.display="none",A.pause(),A.src='',MC.classList.remove('h'),clearInterval(TII),IP=!1,PB.textContent='Reproducir',CP=A.currentTime},O=s=>{S=s;IP=!1;CLI=0;CCI=0;CSD=[];lI(s);lL(s);lCF(s);RP(s.nombre).then(()=>{A.play()});MC.classList.add('h');M.style.display="block";document.querySelector('#sM .mc').focus()},FD=async()=>{try{const t=await fetch(SD);if(!t.ok)throw new Error(`Error! Status: ${t.status}`);const e=await t.json();return e.series}catch(t){return lE(t,'Error:'),[]}},rCAS=s=>{const t=document.getElementById('coc');t.innerHTML="";const sA={};s.forEach(s=>{const nB=s.nombre.split(', temporada')[0].trim();sA[nB]||(sA[nB]=[]);sA[nB].push(s)});const e=[...new Set(s.map(s=>s.pais_origen))].sort();e.forEach(p=>{const n=document.createElement('h2');n.textContent=p;t.appendChild(n);const i=document.createElement('ul');i.classList.add('sl');Object.keys(sA).sort((a,b)=>a.localeCompare(b,'es',{sensitivity:'base'})).forEach(nB=>{const sD=sA[nB].filter(s=>s.pais_origen===p);if(sD.length>0){const e=document.createElement('li'),n=document.createElement('button');n.textContent=nB;n.addEventListener('click',()=>{const sO=[...sD].sort((a,b)=>{const tA=parseInt(a.nombre.split(', temporada ')[1]),tB=parseInt(b.nombre.split(', temporada ')[1]);return tA-tB}),pT=sO[0];O(pT);sO.length>1?lT(sO):document.getElementById('tasc').classList.add('h')});n.setAttribute('tabindex','0');n.classList.add('b');e.appendChild(n);i.appendChild(e)}});t.appendChild(i)});uCW()},lT=s=>{TS.innerHTML='';document.getElementById('tasc').classList.remove('h');s.sort((a,b)=>{const tA=parseInt(a.nombre.split(', temporada ')[1]),tB=parseInt(b.nombre.split(', temporada ')[1]);return tA-tB}).forEach(s=>{const t=s.nombre.split(', temporada ')[1],o=document.createElement('option');o.value=s.nombre;o.textContent=`Temporada ${t}`;TS.appendChild(o)});TS.addEventListener('change',e=>{const sS=s.find(s=>s.nombre===e.target.value);sS&&O(sS)})},lI=s=>{const t=document.getElementById('si');S=s,t.innerHTML=`<h2>${s.nombre}</h2><div><strong>Género:</strong> ${s.genero}</div><div><strong>Año:</strong> ${s.anio}</div><div><strong>Reparto:</strong> ${s.reparto.join(", ")}</div><div><strong>País:</strong> ${s.pais_origen}</div><div><strong>Episodios:</strong> ${s.cantidad_episodios}</div>${s.sinopsis?`<div><strong>Sinopsis:</strong> ${s.sinopsis}</div>`:''}`},lL=s=>{LS.innerHTML='';s.enlaces.length>1?(s.enlaces.forEach((t,e)=>{const n=document.createElement('option');n.value=e,n.textContent=t.idioma,LS.appendChild(n)}),LC.classList.remove('h')):LC.classList.add('h')},lCF=s=>{CS.innerHTML='';CSD=s.capitulos;CSD.forEach((t,e)=>{const n=document.createElement('option');n.value=e,n.textContent=t.titulo,CS.appendChild(n)});CS.value=CCI;uC();A.src=s.enlaces[CLI].enlace;A.load();A.currentTime=CP;IP&&A.play();clearInterval(TII);uT();TII=setInterval(uT,1e3)},uC=()=>{CI.textContent=IP?`Reproduciendo: ${CSD[CCI].titulo}`:`${CSD[CCI].titulo}`},uT=()=>{const t=A.currentTime,e=gCI(t),n=CSD[e],i=n.inicio/1e3,o=n.fin/1e3,r=FT(t-i),c=FT(o-i);CI.textContent=IP?`Reproduciendo: ${CSD[CCI].titulo}`:`${CSD[CCI].titulo}`,TI.textContent=`${r} / ${c}`},tP=()=>{IP?(A.pause(),IP=!1,PB.textContent='Reproducir'):(A.play(),IP=!0,PB.textContent='Pausar')},F=()=>{A.currentTime+=15},B=()=>{A.currentTime-=15},PC=()=>{CCI=parseInt(CS.value);CSD[CCI]?(A.currentTime=CSD[CCI].inicio/1e3,A.play(),IP=!0,PB.textContent='Pausar',uC()):console.warn("Capitulo?")},gCI=t=>{let e=0;return CSD.forEach((n,i)=>{t>=n.inicio/1e3&&t<=n.fin/1e3&&(e=i)}),e},pP=()=>{let t=CCI;t>0&&(t--,CS.value=t,PC())},nP=()=>{let t=CCI;t<CSD.length-1&&(t++,CS.value=t,PC())},cL=()=>{CP=A.currentTime;CLI=parseInt(LS.value),lCF(S)},iV=()=>{A.volume=Math.min(1,A.volume+.05)},dV=()=>{A.volume=Math.max(0,A.volume-.05)},dCW=async s=>{try{const u=auth.currentUser;if(!u)throw new Error("No hay usuario conectado.");await deleteDoc(doc(db,"progresoSeries",`${u.uid}_${s}`));console.log("Serie eliminada de Continuar Viendo:",s);uCW()}catch(e){lE(e,"Error al eliminar la serie de Continuar Viendo")}},uCW=async()=>{CWL.innerHTML='';try{const u=auth.currentUser;if(!u)throw new Error("No hay usuario conectado.");const q=query(collection(db,"progresoSeries"),where("userId","==",u.uid),where("tiempo",">",600)),qS=await getDocs(q),c=[];qS.forEach(d=>{c.push({...d.data(),id:d.id})});const s=await FD();for(const t of c){const ser=s.find(e=>e.nombre===t.serieNombre);if(ser){const cap=ser.capitulos[t.capituloIndex],ini=cap.inicio/1e3,fin=cap.fin/1e3,durR=FT(fin-t.tiempo),li=cLWI(`${ser.nombre}, ${cap.titulo}, ${durR}`,()=>{O(ser);S=ser;RP(ser.nombre)},dCW,t.serieNombre);CWL.appendChild(li)}}}catch(e){lE(e,"Error al actualizar Continuar Viendo")}};CBC.addEventListener('click',C),window.addEventListener('click',t=>{t.target===M&&C()}),CS.addEventListener('change',()=>{S&&GP(S.nombre),PC()}),A.addEventListener('pause',()=>{S&&GP(S.nombre)}),A.addEventListener('play',()=>{IP=!0,PB.textContent='Pausar'}),LS.addEventListener('change',cL),PB.addEventListener('click',tP),document.getElementById('fb').addEventListener('click',F),document.getElementById('bb').addEventListener('click',B),document.getElementById('pcb').addEventListener('click',pP),document.getElementById('ncb').addEventListener('click',nP),document.getElementById('ivb').addEventListener('click',iV),document.getElementById('dvb').addEventListener('click',dV),window.onload=()=>{FD().then(s=>rCAS(s))},setInterval(()=>{M.style.display==="block"&&S&&GP(S.nombre)},5e3);